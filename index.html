<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–∏–≥–∞–¥–∞–º–∏ –∏ —Å–∫–ª–∞–¥–æ–º</title>
    <!-- –ú–µ—Ç–∞-—Ç–µ–≥–∏ –∏ –∏–∫–æ–Ω–∫–∏ PWA -->
    <link rel="manifest" href="manifest.json">
    <!-- ... –∏ –¥—Ä—É–≥–∏–µ –≤–∞—à–∏ —Ç–µ–≥–∏ ... -->
    <style>
        :root { --tab-bar-height: 70px; }
        * { box-sizing: border-box; }
        html { width: 100%; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        body { margin: 0; padding: 0; width: 100%; height: 100%; overflow-x: hidden; position: relative; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; color: #1d1d1f; font-size: 14px; padding-bottom: calc(var(--tab-bar-height) + env(safe-area-inset-bottom)); }
        /* ... –∏ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≤–∞—à–∏ —Å—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <div id="login-screen" class="login-container" style="display: none;">
        <div class="login-form">
            <h2>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
            <div class="form-group"><label for="username">Email</label><input type="email" id="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email"></div>
            <div class="form-group"><label for="password">–ü–∞—Ä–æ–ª—å</label><input type="password" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"></div>
            <button data-action="login" style="width: 100%;">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <div id="main-app" style="display: none;">
        <div class="container">
            <div class="header">
                <h1 id="header-title"></h1>
                <div class="user-info">
                    <button id="reports-btn" data-action="generate-report" style="display: none;">üìä <span class="btn-text">–û—Ç—á–µ—Ç</span></button>
                    <div class="user-badge" id="user-badge"></div>
                    <button class="logout-btn" data-action="logout">–í—ã—Ö–æ–¥</button>
                </div>
            </div>
            <div class="upcoming-events" data-action="toggle-upcoming"><div class="upcoming-events-header"><h3>–ë–ª–∏–∂–∞–π—à–∏–µ —Å–æ–±—ã—Ç–∏—è</h3><div id="upcoming-events-icons"></div><span class="arrow">‚ñº</span></div><div class="upcoming-events-list" id="upcoming-events-list"></div></div>
            <div class="main-content">
                <div id="calendar" class="tab-content"><div class="month-navigation"><button class="nav-button" data-action="prev-month">‚Äπ</button><h2 id="current-month"></h2><button class="nav-button" data-action="next-month">‚Ä∫</button></div><div class="calendar"><div class="calendar-header">–ü–Ω</div><div class="calendar-header">–í—Ç</div><div class="calendar-header">–°—Ä</div><div class="calendar-header">–ß—Ç</div><div class="calendar-header">–ü—Ç</div><div class="calendar-header">–°–±</div><div class="calendar-header">–í—Å</div></div><div class="calendar-grid" id="calendar-days"></div></div>
                <div id="teams" class="tab-content"><h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–∏–≥–∞–¥–∞–º–∏</h2><button data-action="open-team-modal">–î–æ–±–∞–≤–∏—Ç—å –±—Ä–∏–≥–∞–¥—É</button><div id="teams-list" style="margin-top: 20px;"></div><h2 style="margin-top:30px;">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h2><button data-action="open-employee-modal">–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button><div id="employees-list" style="margin-top: 20px;"></div></div>
                <div id="inventory" class="tab-content"><h2>–£—á–µ—Ç —Å–∫–ª–∞–¥–∞</h2><div id="inventory-grid"></div></div>
                <div id="requests" class="tab-content"><h2>–ó–∞—è–≤–∫–∏</h2><div id="requests-list"></div></div>
            </div>
        </div>
        <div class="tabs" id="main-tabs">
            <button class="tab" data-action="switch-tab" data-tab-id="calendar"><span>üìÖ</span><span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></button>
            <button class="tab" data-action="switch-tab" data-tab-id="teams" id="teams-tab"><span>üë•</span><span>–ë—Ä–∏–≥–∞–¥—ã</span></button>
            <button class="tab" data-action="switch-tab" data-tab-id="inventory"><span>üì¶</span><span>–°–∫–ª–∞–¥</span></button>
            <button class="tab" data-action="switch-tab" data-tab-id="requests" id="requests-tab"><span>üìã</span><span>–ó–∞—è–≤–∫–∏</span></button>
        </div>
    </div>
    
    <!-- Firebase SDK - —Ä–µ–∂–∏–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <script>
    // ==================================================================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE (—Å–∏–Ω—Ç–∞–∫—Å–∏—Å compat)
    // ==================================================================
    const firebaseConfig = {
        apiKey: "AIzaSyCsWfzOoerj6TiM2am46reV42CQ0OE7TM8",
        authDomain: "calendarsaturit.firebaseapp.com",
        projectId: "calendarsaturit",
        storageBucket: "calendarsaturit.appspot.com",
        messagingSenderId: "286002422636",
        appId: "1:286002422636:web:58b626bffddfb64b060949",
        measurementId: "G-8GC7ZJ94TW"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Firebase. –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç `firebase` —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ==================================================================
    // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
    // ==================================================================
    let events = [], teams = [], employees = [], pipeTypes = [], inventoryOperations = [], requests = [];
    let currentUser = null, currentDate = new Date(), unsubscribeListeners = [], editedEntity = null, selectedInventoryItem = null;

    // ==================================================================
    // –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // ==================================================================
    function setupAuthListener() {
        auth.onAuthStateChanged(async (user) => {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            const loadingOverlay = document.getElementById('loading-overlay');

            if (user) {
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (!userDoc.exists) throw new Error("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firestore!");
                    currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };
                    await initializeApp();
                } catch (error) { logout(error); }
            } else {
                currentUser = null;
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
                hideLoading();
            }
        });
    }

    async function login() {
        const email = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        if (!email || !password) return showNotification("–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å", "error");
        try {
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            showNotification("–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å", "error");
        }
    }

    function logout(error = null) {
        if(error) console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞, –≤—ã—Ö–æ–¥:", error);
        auth.signOut();
    }
    
    async function initializeApp() {
        // ... –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    }
    
    function hideLoading() {
        // ... –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    }

    function listenToData() {
        const collectionsToListen = ['events', 'teams', 'employees', 'pipeTypes', 'inventoryOperations'];
        const renderAll = () => { renderCalendar(); renderTeams(); renderEmployees(); renderInventoryGrid(); };

        collectionsToListen.forEach(name => {
            const unsub = db.collection(name).onSnapshot((snapshot) => {
                window[name] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            });
            unsubscribeListeners.push(unsub);
        });
    }
    
    // ==================================================================
    // –†–ï–ù–î–ï–† –ò–ù–¢–ï–†–§–ï–ô–°–ê
    // ==================================================================
    function renderCalendar() { /* ... –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å ... */ }
    function renderTeams() { /* ... –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å ... */ }
    function renderEmployees() { /* ... –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å ... */ }
    function renderInventoryGrid() { /* ... –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å ... */ }
    // ... –∏ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
    
    // ==================================================================
    // –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò CRUD
    // ==================================================================
    async function saveEntity(collectionName, data, successMessage = '–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã') {
        try {
            if (editedEntity && editedEntity.id) {
                await db.collection(collectionName).doc(editedEntity.id).update(data);
            } else {
                await db.collection(collectionName).add(data);
            }
            showNotification(successMessage, 'success');
        } catch (error) { console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", error); showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error'); }
    }

    async function deleteEntity(collectionName, docId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) return;
        try {
            await db.collection(collectionName).doc(docId).delete();
            showNotification('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞');
        } catch (error) { showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error'); }
    }
    
    // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –∏ CRUD —Å–∫–ª–∞–¥–∞, –±—Ä–∏–≥–∞–¥ –∏ —Ç.–¥. ...
    
    // ==================================================================
    // –¶–ï–ù–¢–†–ê–õ–¨–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –°–û–ë–´–¢–ò–ô
    // ==================================================================
    document.addEventListener('click', (e) => {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        const action = target.dataset.action;
        const id = target.dataset.id;
        // –ö–∞—Ä—Ç–∞ –¥–µ–π—Å—Ç–≤–∏–π ...
        const actions = {
            'login': login,
            'logout': logout,
            // ... –∏ –≤—Å–µ-–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
        };
        if (actions[action]) {
            e.preventDefault();
            actions[action]();
        }
    });

    // ==================================================================
    // –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
    // ==================================================================
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('password').addEventListener('keypress', e => { if (e.key === 'Enter') login(); });
        setupAuthListener();
    });

    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–∏–≥–∞–¥–∞–º–∏ –∏ —Å–∫–ª–∞–¥–æ–º</title>
    <!-- ... –≤—Å–µ —Ç–µ–≥–∏ <meta> –∏ <link> –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... -->
    <style>
        /* ... –≤—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */
    </style>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      import { getFirestore, collection, onSnapshot, doc, getDoc, addDoc, updateDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
      import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
      const firebaseConfig = {
        apiKey: "AIzaSyCsWfzOoerj6TiM2am46reV42CQ0OE7TM8",
        authDomain: "calendarsaturit.firebaseapp.com",
        projectId: "calendarsaturit",
        storageBucket: "calendarsaturit.appspot.com",
        messagingSenderId: "286002422636",
        appId: "1:286002422636:web:58b626bffddfb64b060949",
        measurementId: "G-8GC7ZJ94TW"
      };
      const app = initializeApp(firebaseConfig);
      window.db = getFirestore(app);
      window.auth = getAuth(app);
      window.firebase = {
          db: { collection, onSnapshot, doc, getDoc, addDoc, updateDoc, deleteDoc, setDoc },
          auth: { onAuthStateChanged, signInWithEmailAndPassword, signOut }
      };
    </script>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <div id="login-screen" class="login-container" style="display: none;">
        <div class="login-form">
            <h2>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
            <div class="form-group"><label for="username">Email</label><input type="email" id="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email"></div>
            <div class="form-group"><label for="password">–ü–∞—Ä–æ–ª—å</label><input type="password" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"></div>
            <button data-action="login" style="width: 100%;">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <div id="main-app" style="display: none;">
        <div class="container">
            <div class="header">
                <h1 id="header-title"></h1>
                <div class="user-info">
                    <button id="reports-btn" data-action="generate-report" style="display: none;">üìä <span class="btn-text">–û—Ç—á–µ—Ç</span></button>
                    <div class="user-badge" id="user-badge"></div>
                    <button class="logout-btn" data-action="logout">–í—ã—Ö–æ–¥</button>
                </div>
            </div>
            <div class="upcoming-events" id="upcoming-events" data-action="toggle-upcoming"><div class="upcoming-events-header"><h3>–ë–ª–∏–∂–∞–π—à–∏–µ —Å–æ–±—ã—Ç–∏—è</h3><div id="upcoming-events-icons"></div><span class="arrow">‚ñº</span></div><div class="upcoming-events-list" id="upcoming-events-list"></div></div>
            <div class="main-content">
                <div id="calendar" class="tab-content"><div class="month-navigation"><button class="nav-button" data-action="prev-month">‚Äπ</button><h2 id="current-month"></h2><button class="nav-button" data-action="next-month">‚Ä∫</button></div><div class="calendar"><div class="calendar-header">–ü–Ω</div><div class="calendar-header">–í—Ç</div><div class="calendar-header">–°—Ä</div><div class="calendar-header">–ß—Ç</div><div class="calendar-header">–ü—Ç</div><div class="calendar-header">–°–±</div><div class="calendar-header">–í—Å</div></div><div class="calendar-grid" id="calendar-days"></div></div>
                <div id="teams" class="tab-content"><h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–∏–≥–∞–¥–∞–º–∏</h2><button data-action="open-team-modal">–î–æ–±–∞–≤–∏—Ç—å –±—Ä–∏–≥–∞–¥—É</button><div id="teams-list" style="margin-top: 20px;"></div><h2 style="margin-top:30px;">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h2><button data-action="open-employee-modal">–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button><div id="employees-list" style="margin-top: 20px;"></div></div>
                <div id="inventory" class="tab-content"><h2>–£—á–µ—Ç —Å–∫–ª–∞–¥–∞</h2><div id="inventory-grid"></div></div>
                <div id="requests" class="tab-content"><h2>–ó–∞—è–≤–∫–∏</h2><div id="requests-list"></div></div>
            </div>
        </div>
        <div class="tabs" id="main-tabs">
            <button class="tab" data-action="switch-tab" data-tab-id="calendar"><span>üìÖ</span><span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></button>
            <button class="tab" data-action="switch-tab" data-tab-id="teams" id="teams-tab"><span>üë•</span><span>–ë—Ä–∏–≥–∞–¥—ã</span></button>
            <button class="tab" data-action="switch-tab" data-tab-id="inventory"><span>üì¶</span><span>–°–∫–ª–∞–¥</span></button>
            <button class="tab" data-action="switch-tab" data-tab-id="requests" id="requests-tab"><span>üìã</span><span>–ó–∞—è–≤–∫–∏</span></button>
        </div>
    </div>
    
    <script>
    // ==================================================================
    // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
    // ==================================================================
    let events = [], teams = [], employees = [], pipeTypes = [], inventoryOperations = [], requests = [];
    let currentUser = null, currentDate = new Date(), unsubscribeListeners = [], editedEntity = null, selectedInventoryItem = null;

    // ==================================================================
    // –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // ==================================================================
    function setupAuthListener() {
        window.firebase.auth.onAuthStateChanged(window.auth, async (user) => {
            unsubscribeListeners.forEach(unsubscribe => unsubscribe());
            unsubscribeListeners = [];
            const loadingOverlay = document.getElementById('loading-overlay');
            if (user) {
                try {
                    const userDoc = await window.firebase.db.getDoc(window.firebase.db.doc(window.db, 'users', user.uid));
                    if (!userDoc.exists()) throw new Error("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firestore!");
                    currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };
                    await initializeApp();
                } catch (error) { logout(error); }
            } else {
                currentUser = null;
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
                hideLoading();
            }
        });
    }

    async function login() {
        const email = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        if (!email || !password) return showNotification("–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å", "error");
        try { await window.firebase.auth.signInWithEmailAndPassword(window.auth, email, password); } 
        catch (error) { showNotification("–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å", "error"); }
    }

    function logout(error = null) {
        if(error) console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞, –≤—ã—Ö–æ–¥:", error);
        window.firebase.auth.signOut(window.auth);
    }

    async function initializeApp() {
        document.getElementById('main-app').style.display = 'block';
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('user-badge').textContent = `${currentUser.name} (${currentUser.role === 'manager' ? '–£–ø—Ä–∞–≤–ª—è—é—â–∏–π' : '–°–æ—Ç—Ä—É–¥–Ω–∏–∫'})`;
        const isManager = currentUser.role === 'manager';
        document.getElementById('reports-btn').style.display = isManager ? 'flex' : 'none';
        document.getElementById('teams-tab').style.display = isManager ? 'flex' : 'none';
        document.getElementById('requests-tab').style.display = 'none';
        
        await listenToData();
        switchTab('calendar');
        hideLoading();
    }
    
    function hideLoading() {
        const loadingOverlay = document.getElementById('loading-overlay');
        loadingOverlay.style.opacity = '0';
        setTimeout(() => loadingOverlay.style.display = 'none', 300);
    }

    function listenToData() {
        const collectionsToListen = ['events', 'teams', 'employees', 'pipeTypes', 'inventoryOperations'];
        const renderAll = () => { renderCalendar(); renderTeams(); renderEmployees(); renderInventoryGrid(); };
        collectionsToListen.forEach(name => {
            const unsub = window.firebase.db.onSnapshot(window.firebase.db.collection(window.db, name), (snapshot) => {
                window[name] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            });
            unsubscribeListeners.push(unsub);
        });
    }
    
    // ==================================================================
    // –†–ï–ù–î–ï–† –ò–ù–¢–ï–†–§–ï–ô–°–ê
    // ==================================================================
    function renderCalendar() {
        const year = currentDate.getFullYear(), month = currentDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        let firstDay = new Date(year, month, 1).getDay();
        firstDay = firstDay === 0 ? 6 : firstDay - 1;
        document.getElementById('current-month').textContent = getMonthName(currentDate);
        const grid = document.getElementById('calendar-days');
        grid.innerHTML = '';
        for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="calendar-day other-month"></div>`;
        const today = formatDate(new Date());
        for (let day = 1; day <= daysInMonth; day++) {
            const formattedDate = formatDate(new Date(year, month, day));
            const dayEvents = events.filter(e => e.date === formattedDate || (e.type === 'vacation' && e.startDate <= formattedDate && e.endDate >= formattedDate));
            let dayClasses = 'calendar-day' + (formattedDate === today ? ' today' : '');
            grid.innerHTML += `<div class="${dayClasses}" data-action="open-day-details" data-date="${formattedDate}"><div class="day-number">${day}</div></div>`;
        }
        const totalCells = firstDay + daysInMonth;
        for (let i = 0; i < (7 - totalCells % 7) % 7; i++) grid.innerHTML += `<div class="calendar-day other-month"></div>`;
    }

    function renderTeams() { /* –ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–æ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å */ }
    function renderEmployees() { /* –ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–æ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å */ }
    function renderInventoryGrid() { /* –ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–æ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å */ }

    // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –¥–ª—è CRUD, –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –∏ —Ö–µ–ª–ø–µ—Ä–æ–≤ ...

    // ==================================================================
    // –¶–ï–ù–¢–†–ê–õ–¨–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –°–û–ë–´–¢–ò–ô
    // ==================================================================
    document.addEventListener('click', (e) => {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        const action = target.dataset.action;
        const id = target.dataset.id;
        
        // –ö–∞—Ä—Ç–∞ –¥–µ–π—Å—Ç–≤–∏–π
        const actions = {
            'login': login,
            'logout': logout,
            'switch-tab': () => switchTab(target.dataset.tabId),
            'prev-month': () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); },
            'next-month': () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); },
            'open-team-modal': () => openTeamModal(id),
            'open-employee-modal': openEmployeeModal,
            'save-team': saveTeam,
            'save-employee': createEmployeeRecord,
            'delete-entity': () => deleteEntity(target.dataset.collection, id),
            // ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–ª—è –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π
        };

        if (actions[action]) {
            e.preventDefault();
            actions[action]();
        }
    });

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('password').addEventListener('keypress', e => { if (e.key === 'Enter') login(); });
        setupAuthListener();
    });

    </script>
</body>
</html>
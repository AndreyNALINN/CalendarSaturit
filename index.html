<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–∏–≥–∞–¥–∞–º–∏ –∏ —Å–∫–ª–∞–¥–æ–º</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --tab-bar-height: 70px; }
        * { box-sizing: border-box; }
        html { width: 100%; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        body { margin: 0; padding: 0; width: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; color: #1d1d1f; font-size: 14px; padding-bottom: calc(var(--tab-bar-height) + env(safe-area-inset-bottom)); }
        *:not(script):not(style) { -webkit-user-select: none; user-select: none; }
        input, textarea, select { -webkit-user-select: text; user-select: text; }
        .container { max-width: 100%; margin: 0 auto; padding: 10px; }
        .header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .header h1 { margin: 0; font-size: 18px; font-weight: 600; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-badge { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 6px 12px; border-radius: 15px; font-size: 12px; }
        .logout-btn { background: #ff3b30; color: white; border: none; padding: 8px 14px; border-radius: 15px; cursor: pointer; font-size: 13px; min-height: 40px; }
        .main-content { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 15px; }
        .tabs { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--tab-bar-height); display: grid; grid-template-columns: repeat(4, 1fr); background: rgba(248, 249, 250, 0.7); backdrop-filter: blur(15px); border-top: 1px solid rgba(0, 0, 0, 0.1); z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .tab { padding: 4px; text-align: center; cursor: pointer; border: none; background: transparent; font-size: 11px; color: #6c757d; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; height: 100%; border-top: 3px solid transparent; }
        .tab span:first-child { font-size: 20px; }
        .tab.active { color: #667eea; border-top-color: #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e9ecef; border-radius: 8px; overflow: hidden; }
        .calendar-header { text-align: center; font-weight: 600; padding: 10px 4px; background: #667eea; color: white; font-size: 12px; }
        .calendar-day { background: white; padding: 2px; aspect-ratio: 1 / 1.5; overflow-y: auto; position: relative; cursor: pointer; display: flex; flex-direction: column; }
        .calendar-day.today .day-number { background-color: #007aff; color: white; border-radius: 50%; width: 20px; height: 20px; display:inline-flex; align-items:center; justify-content:center; }
        .calendar-day.other-month { background: #f8f9fa; cursor: default; }
        .day-number { font-weight: 600; font-size: 10px; padding: 2px; }
        .event { font-size: 8px; color: white; padding: 1px 3px; border-radius: 3px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        .modal-content { background: white; padding: 20px; border-radius: 12px; width: 100%; max-width: 420px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; }
        input, select, textarea { width: 100%; padding: 12px 14px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 14px; }
        button { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 18px; border-radius: 12px; cursor: pointer; font-size: 14px; font-weight: 500; min-height: 44px; }
        .button-secondary { background: #6c757d; }
        .button-danger { background: #ff3b30; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05); }
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-form { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 30px 20px; width: 100%; max-width: 350px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2); }
        .notification { position: fixed; top: 15px; right: 15px; background: #28a745; color: white; padding: 12px 16px; border-radius: 8px; z-index: 1001; }
        .month-navigation { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 12px 15px; background: white; border-radius: 10px; }
        .nav-button { background: #667eea; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; min-height: 40px; }
        .team-type-selector, .role-selector { display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
        .team-type-option, .role-option { flex: 1; background: #f8f9fa; border: 2px solid #e9ecef; color: #495057; padding: 12px 14px; border-radius: 12px; cursor: pointer; text-align: center; }
        .team-type-option.selected, .role-option.selected { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-color: #667eea; }
        .modal .button-group-end { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: flex; justify-content: center; align-items: center; z-index: 9999; font-size: 18px; color: #667eea; font-weight: 500; transition: opacity 0.3s ease; }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <div id="login-screen" class="login-container" style="display: none;">
        <div class="login-form">
            <h2>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
            <div class="form-group"><label for="username">Email</label><input type="email" id="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email"></div>
            <div class="form-group"><label for="password">–ü–∞—Ä–æ–ª—å</label><input type="password" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"></div>
            <button data-action="login" style="width: 100%;">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <div id="main-app" style="display: none;">
        <div class="container">
            <div class="header">
                <h1 id="header-title"></h1>
                <div class="user-info">
                    <div class="user-badge" id="user-badge"></div>
                    <button class="logout-btn" data-action="logout">–í—ã—Ö–æ–¥</button>
                </div>
            </div>
            <div class="main-content">
                <div id="calendar" class="tab-content">
                    <div class="month-navigation"><button class="nav-button" data-action="prev-month">‚Äπ</button><h2 id="current-month"></h2><button class="nav-button" data-action="next-month">‚Ä∫</button></div>
                    <div class="calendar-grid" id="calendar-days"></div>
                </div>
                <div id="teams" class="tab-content"><h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–∏–≥–∞–¥–∞–º–∏</h2><button data-action="open-team-modal">–î–æ–±–∞–≤–∏—Ç—å –±—Ä–∏–≥–∞–¥—É</button><div id="teams-list" style="margin-top: 20px;"></div><h2 style="margin-top:30px;">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h2><button data-action="open-employee-modal">–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button><div id="employees-list" style="margin-top: 20px;"></div></div>
                <div id="inventory" class="tab-content"><h2>–£—á–µ—Ç —Å–∫–ª–∞–¥–∞</h2><div id="inventory-grid"></div></div>
                <div id="requests" class="tab-content"><h2>–ó–∞—è–≤–∫–∏</h2><div id="requests-list"></div></div>
            </div>
        </div>
        <div class="tabs" id="main-tabs">
            <button class="tab" data-action="switch-tab" data-tab-id="calendar"><span>üìÖ</span><span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></button>
            <button class="tab" data-action="switch-tab" data-tab-id="teams" id="teams-tab"><span>üë•</span><span>–ë—Ä–∏–≥–∞–¥—ã</span></button>
            <button class="tab" data-action="switch-tab" data-tab-id="inventory"><span>üì¶</span><span>–°–∫–ª–∞–¥</span></button>
            <button class="tab" data-action="switch-tab" data-tab-id="requests" id="requests-tab"><span>üìã</span><span>–ó–∞—è–≤–∫–∏</span></button>
        </div>
    </div>
    
    <!-- Firebase SDK - —Ä–µ–∂–∏–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <script>
    const firebaseConfig = {
        apiKey: "AIzaSyCsWfzOoerj6TiM2am46reV42CQ0OE7TM8",
        authDomain: "calendarsaturit.firebaseapp.com",
        projectId: "calendarsaturit",
        storageBucket: "calendarsaturit.appspot.com",
        messagingSenderId: "286002422636",
        appId: "1:286002422636:web:58b626bffddfb64b060949",
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let events = [], teams = [], employees = [], pipeTypes = [], inventoryOperations = [];
    let currentUser = null, currentDate = new Date(), unsubscribeListeners = [], editedEntity = null, selectedInventoryItem = null;

    // AUTH & INIT
    auth.onAuthStateChanged(async (user) => {
        unsubscribeListeners.forEach(unsub => unsub());
        unsubscribeListeners = [];
        if (user) {
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (!userDoc.exists) throw new Error("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firestore!");
                currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };
                await initializeApp();
            } catch (error) { logout(error); }
        } else {
            currentUser = null;
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            hideLoading();
        }
    });

    async function login() {
        const email = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        if (!email || !password) return showNotification("–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å", "error");
        try { await auth.signInWithEmailAndPassword(email, password); } 
        catch (error) { showNotification("–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å", "error"); }
    }

    function logout(error = null) {
        if(error) console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞, –≤—ã—Ö–æ–¥:", error);
        auth.signOut();
    }

    async function initializeApp() {
        document.getElementById('main-app').style.display = 'block';
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('user-badge').textContent = `${currentUser.name} (${currentUser.role === 'manager' ? '–£–ø—Ä–∞–≤–ª—è—é—â–∏–π' : '–°–æ—Ç—Ä—É–¥–Ω–∏–∫'})`;
        document.getElementById('teams-tab').style.display = currentUser.role === 'manager' ? 'flex' : 'none';
        document.getElementById('requests-tab').style.display = 'none';
        listenToData();
        switchTab('calendar');
        hideLoading();
    }

    function hideLoading() {
        const loadingOverlay = document.getElementById('loading-overlay');
        loadingOverlay.style.opacity = '0';
        setTimeout(() => loadingOverlay.style.display = 'none', 300);
    }

    function listenToData() {
        const collections = ['events', 'teams', 'employees', 'pipeTypes', 'inventoryOperations'];
        const renderAll = () => { renderCalendar(); renderTeams(); renderEmployees(); renderInventoryGrid(); };
        collections.forEach(name => {
            const unsub = db.collection(name).onSnapshot(snapshot => {
                window[name] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            }, error => console.error(`–û—à–∏–±–∫–∞ '${name}':`, error));
            unsubscribeListeners.push(unsub);
        });
    }

    // RENDERING
    function renderCalendar() {
        const year = currentDate.getFullYear(), month = currentDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        let firstDay = new Date(year, month, 1).getDay();
        firstDay = firstDay === 0 ? 6 : firstDay - 1;
        document.getElementById('current-month').textContent = getMonthName(currentDate);
        const grid = document.getElementById('calendar-days');
        const headers = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
        grid.innerHTML = headers.map(h => `<div class="calendar-header">${h}</div>`).join('');
        for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="calendar-day other-month"></div>`;
        const today = formatDate(new Date());
        for (let day = 1; day <= daysInMonth; day++) {
            const formattedDate = formatDate(new Date(year, month, day));
            const dayEvents = events.filter(e => (e.date === formattedDate) || (e.type === 'vacation' && e.startDate <= formattedDate && e.endDate >= formattedDate));
            let dayClasses = 'calendar-day' + (formattedDate === today ? ' today' : '');
            let eventsHtml = dayEvents.map(event => {
                let color = event.type === 'vacation' ? '#34c759' : getTeamColor(event.teamId);
                let text = event.type === 'vacation' ? `üèñÔ∏è ${getEmployeeName(event.employeeId)}` : getTeamName(event.teamId);
                return `<div class="event" style="background-color:${color};" title="${text}">${text}</div>`;
            }).join('');
            grid.innerHTML += `<div class="${dayClasses}" data-action="open-day-details" data-date="${formattedDate}"><div class="day-number">${day}</div>${eventsHtml}</div>`;
        }
    }
    function renderTeams() {
        const list = document.getElementById('teams-list');
        list.innerHTML = teams.map(team => `
            <div class="card"><div style="display:flex; justify-content:space-between; align-items:center;">
            <div><h3 style="margin:0;">${team.name}</h3><span style="font-size:12px; color:#fff; background-color:${team.color}; padding:3px 8px; border-radius:10px;">${team.type}</span></div>
            <div><button class="button-secondary" data-action="open-team-modal" data-id="${team.id}">–ò–∑–º.</button><button class="button-danger" data-action="delete-entity" data-collection="teams" data-id="${team.id}">–£–¥–ª.</button></div>
            </div></div>`).join('') || '<p>–ë—Ä–∏–≥–∞–¥ –ø–æ–∫–∞ –Ω–µ—Ç.</p>';
    }
    function renderEmployees() {
        const list = document.getElementById('employees-list');
        list.innerHTML = employees.map(emp => `
            <div class="card"><div style="display:flex; justify-content:space-between; align-items:center;">
            <div><p style="margin:0;font-weight:600;">${emp.name}</p><p style="margin:4px 0 0;font-size:12px;color:#6c757d;">${emp.role}</p></div>
            <button class="button-danger" data-action="delete-entity" data-collection="employees" data-id="${emp.id}">–£–¥–∞–ª–∏—Ç—å</button>
            </div></div>`).join('') || '<p>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>';
    }
    function renderInventoryGrid() {
        const grid = document.getElementById('inventory-grid');
        const allItems = [ ...pipeTypes, { id: 'fuel', name: "üõ¢Ô∏è –î–∏–∑–µ–ª—å–Ω–æ–µ —Ç–æ–ø–ª–∏–≤–æ", minStock: 100, isFuel: true }];
        let html = `<button data-action="open-pipe-type-modal">+ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—É</button>`;
        allItems.forEach(item => {
            const currentAmount = calculateCurrentAmount(item.id);
            const needsRestock = currentAmount < item.minStock;
            html += `<div class="card" data-action="open-inventory-history" data-id="${item.id}" data-name="${item.name}" data-is-fuel="${item.isFuel || false}" style="cursor:pointer; margin-top:10px;"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;"><div style="font-weight: 600;">${item.name}</div><div style="font-weight: bold; font-size: 20px; color: #667eea;">${currentAmount}${item.isFuel ? ' –ª' : ' –º'}</div></div>${needsRestock ? `<div style="color: #ff3b30; font-size: 12px;">‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ (–º–∏–Ω. ${item.minStock})</div>` : ''}</div>`;
        });
        grid.innerHTML = html;
    }

    // MODALS & CRUD
    async function saveEntity(collectionName, data, successMessage = '–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã') {
        try {
            if (editedEntity && editedEntity.id) { await db.collection(collectionName).doc(editedEntity.id).update(data); } 
            else { await db.collection(collectionName).add(data); }
            showNotification(successMessage, 'success');
        } catch (error) { showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error'); }
    }
    async function deleteEntity(collectionName, docId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) return;
        try { await db.collection(collectionName).doc(docId).delete(); showNotification('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞'); } 
        catch (error) { showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error'); }
    }
    function openTeamModal(teamId = null) {
        editedEntity = teamId ? teams.find(t => t.id === teamId) : {};
        createModal('team-modal', {
            title: editedEntity.id ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±—Ä–∏–≥–∞–¥—É' : '–î–æ–±–∞–≤–∏—Ç—å –±—Ä–∏–≥–∞–¥—É',
            body: `<div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="team-name" value="${editedEntity.name || ''}"></div><div class="form-group"><label>–¢–∏–ø</label><div class="team-type-selector" id="modal-team-type"></div></div><div class="form-group"><label>–¶–≤–µ—Ç</label><input type="color" id="team-color" value="${editedEntity.color || '#a7c7e7'}" style="width:100%; height:40px;"></div>`,
            footer: `<button class="button-secondary" data-action="close-modal" data-id="team-modal">–û—Ç–º–µ–Ω–∞</button><button data-action="save-team">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`
        });
        const teamTypes = { drillers: '–ë—É—Ä–∏–ª—å—â–∏–∫–∏', installers: '–ú–æ–Ω—Ç–∞–∂–Ω–∏–∫–∏', drivers: '–í–æ–¥–∏—Ç–µ–ª–∏' };
        document.getElementById('modal-team-type').innerHTML = Object.keys(teamTypes).map(key => `<button class="team-type-option ${editedEntity.type === key ? 'selected' : ''}" data-action="select-option" data-class="team-type-option" data-input="#modal-team-type-value" data-value="${key}">${teamTypes[key]}</button>`).join('') + `<input type="hidden" id="modal-team-type-value" value="${editedEntity.type || 'drillers'}">`;
    }
    async function saveTeam() { const data = { name: document.getElementById('team-name').value.trim(), type: document.getElementById('modal-team-type-value').value, color: document.getElementById('team-color').value }; if (!data.name) return showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'error'); await saveEntity('teams', data, '–ë—Ä–∏–≥–∞–¥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞'); closeModal('team-modal'); }
    function openEmployeeModal() {
        createModal('employee-modal', {
            title: '–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞',
            body: `<p style="font-size:13px; color:#6c757d; margin-top:0;"><b>–®–∞–≥ 1:</b> –í –∫–æ–Ω—Å–æ–ª–∏ Firebase (Authentication) —Å–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å).<br><b>–®–∞–≥ 2:</b> –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ User UID –∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞.</p><div class="form-group"><label>–§–ò–û</label><input id="employee-name"></div><div class="form-group"><label>User UID</label><input id="employee-uid"></div><div class="form-group"><label>–†–æ–ª—å</label><div class="role-selector" id="modal-role"></div></div>`,
            footer: `<button class="button-secondary" data-action="close-modal" data-id="employee-modal">–û—Ç–º–µ–Ω–∞</button><button data-action="save-employee">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`
        });
        const roles = { manager: '–£–ø—Ä–∞–≤–ª—è—é—â–∏–π', employee: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫' };
        document.getElementById('modal-role').innerHTML = Object.keys(roles).map(key => `<button class="role-option" data-action="select-option" data-class="role-option" data-input="#modal-role-value" data-value="${key}">${roles[key]}</button>`).join('') + `<input type="hidden" id="modal-role-value" value="employee">`;
    }
    async function createEmployeeRecord() {
        const name = document.getElementById('employee-name').value.trim(); const uid = document.getElementById('employee-uid').value.trim(); const role = document.getElementById('modal-role-value').value;
        if (!name || !uid || !role) return showNotification("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è", "error");
        try {
            await db.collection('users').doc(uid).set({ name, role });
            await db.collection('employees').add({ name, role, uid });
            showNotification("–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω!", "success");
            closeModal('employee-modal');
        } catch (error) { showNotification(error.message, "error"); }
    }
    function calculateCurrentAmount(itemId) { return inventoryOperations.filter(op => op.itemId === itemId).reduce((sum, op) => op.type === "in" ? sum + Number(op.amount) : sum - Number(op.amount), 0); }
    function openInventoryHistoryModal(itemId, itemName, isFuel) {
        selectedInventoryItem = { id: itemId, name: itemName, isFuel };
        createModal('inventory-history-modal', {
            title: `–ò—Å—Ç–æ—Ä–∏—è: ${itemName}`,
            body: `<div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0;">–û—Å—Ç–∞—Ç–æ–∫: ${calculateCurrentAmount(itemId)}${isFuel ? ' –ª' : ' –º'}</h3><button data-action="open-inventory-op-modal">–û–ø–µ—Ä–∞—Ü–∏—è</button></div><div style="max-height:40vh;overflow-y:auto;margin-top:15px;"><table><thead><tr><th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>–ö–æ–ª-–≤–æ</th><th>–ü—Ä–∏–º.</th></tr></thead><tbody id="inventory-history-table"></tbody></table></div>`,
            footer: `<button class="button-secondary" data-action="close-modal" data-id="inventory-history-modal">–ó–∞–∫—Ä—ã—Ç—å</button>`
        });
        const ops = inventoryOperations.filter(op => op.itemId === itemId).sort((a,b) => new Date(b.date) - new Date(a.date));
        document.getElementById('inventory-history-table').innerHTML = ops.length ? ops.map(op => `<tr><td>${op.date.split('-').reverse().join('.')}</td><td>${op.type==='in'?'üìà':'üìâ'}</td><td style="color:${op.type==='in'?'#28a745':'#dc3545'}">${op.type==='in'?'+':'-'}${op.amount}</td><td>${op.notes||''}</td></tr>`).join('') : `<tr><td colspan="4" style="text-align:center;padding:20px;">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</td></tr>`;
    }
    function openInventoryOperationModal() {
        createModal('inventory-op-modal', {
            title: `–û–ø–µ—Ä–∞—Ü–∏—è: ${selectedInventoryItem.name}`,
            body: `<div class="form-group"><label>–¢–∏–ø</label><div style="display:flex;gap:10px;"><button id="op-type-in" data-action="select-op-type" data-type="in">–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ</button><button id="op-type-out" data-action="select-op-type" data-type="out">–†–∞—Å—Ö–æ–¥</button></div><input type="hidden" id="inventory-op-type"></div><div class="form-group"><label>–î–∞—Ç–∞</label><input type="date" id="inventory-op-date"></div><div class="form-group"><label>–ö–æ–ª-–≤–æ</label><input type="number" id="inventory-op-amount"></div><div class="form-group"><label>–ü—Ä–∏–º.</label><input type="text" id="inventory-op-notes"></div>`,
            footer: `<button class="button-secondary" data-action="close-modal" data-id="inventory-op-modal">–û—Ç–º–µ–Ω–∞</button><button data-action="save-inventory-op">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`
        });
        document.getElementById('inventory-op-date').value = formatDate(new Date()); selectOperationType('in');
    }
    function selectOperationType(type) { document.getElementById('inventory-op-type').value = type; document.getElementById('op-type-in').style.background = type === 'in' ? '#28a745' : '#6c757d'; document.getElementById('op-type-out').style.background = type === 'out' ? '#dc3545' : '#6c757d'; }
    async function saveInventoryOperation() { const data = { itemId: selectedInventoryItem.id, type: document.getElementById('inventory-op-type').value, date: document.getElementById('inventory-op-date').value, amount: Number(document.getElementById('inventory-op-amount').value), notes: document.getElementById('inventory-op-notes').value.trim() }; if(!data.date || !data.amount > 0) return showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞—Ç—É –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ', 'error'); await saveEntity('inventoryOperations', data, '–û–ø–µ—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞'); closeModal('inventory-op-modal'); }
    function openPipeTypeModal(itemId = null) { editedEntity = itemId ? pipeTypes.find(i => i.id === itemId) : {}; createModal('pipe-type-modal', { title: editedEntity.id ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—É', body: `<div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="pipe-type-name" value="${editedEntity.name || ''}"></div><div class="form-group"><label>–ú–∏–Ω. –æ—Å—Ç–∞—Ç–æ–∫</label><input type="number" id="pipe-type-minstock" value="${editedEntity.minStock || 0}"></div>`, footer: `<button class="button-secondary" data-action="close-modal" data-id="pipe-type-modal">–û—Ç–º–µ–Ω–∞</button><button data-action="save-pipe-type">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`}); }
    async function savePipeType() { const data = { name: document.getElementById('pipe-type-name').value, minStock: Number(document.getElementById('pipe-type-minstock').value) }; if (!data.name) return showNotification("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ", "error"); await saveEntity('pipeTypes', data, '–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞'); closeModal('pipe-type-modal'); }

    // HELPERS & EVENT HANDLING
    function showNotification(msg, type='success') { const el=document.createElement('div'); el.className='notification'; el.textContent=msg; el.style.background=type==='error'?'#ff3b30':'#28a745'; document.body.appendChild(el); setTimeout(() => el.remove(), 3000); }
    function formatDate(d) { d = new Date(d); return [d.getFullYear(), `${d.getMonth()+1}`.padStart(2,'0'), `${d.getDate()}`.padStart(2,'0')].join('-'); }
    function getMonthName(d) { return d.toLocaleString('ru-RU', { month: 'long', year: 'numeric' }); }
    function getTeamName(id) { return teams.find(t => t.id === id)?.name || "?"; }
    function getTeamColor(id) { return teams.find(t => t.id === id)?.color || "#ccc"; }
    function getEmployeeName(id) { return employees.find(e => e.id === id)?.name || "?"; }
    function createModal(id, content) { let m=document.getElementById(id); if (m) m.remove(); m = document.createElement('div'); m.id = id; m.className = 'modal'; m.innerHTML = `<div class="modal-content"><h2>${content.title}</h2>${content.body}<div class="button-group-end">${content.footer}</div></div>`; document.body.appendChild(m); m.style.display = 'flex'; }
    function closeModal(id) { const m = document.getElementById(id); if (m) m.remove(); }
    function switchTab(tabId) { document.querySelectorAll('.tab-content, .tab').forEach(el => el.classList.remove('active')); document.getElementById(tabId)?.classList.add('active'); document.querySelector(`[data-tab-id="${tabId}"]`)?.classList.add('active'); const title = document.querySelector(`[data-tab-id="${tabId}"] span:last-child`)?.textContent || '–ö–∞–ª–µ–Ω–¥–∞—Ä—å'; document.getElementById('header-title').textContent = title; document.querySelector('.header').style.display = 'flex'; }
    
    document.body.addEventListener('click', (e) => {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        const action = target.dataset.action;
        const id = target.dataset.id;
        const actions = {
            'login': login, 'logout': logout,
            'switch-tab': () => switchTab(target.dataset.tabId),
            'prev-month': () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); },
            'next-month': () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); },
            'open-team-modal': () => openTeamModal(id),
            'save-team': saveTeam,
            'open-employee-modal': openEmployeeModal,
            'save-employee': createEmployeeRecord,
            'delete-entity': () => deleteEntity(target.dataset.collection, id),
            'select-option': () => { const el=target.parentElement; el.querySelectorAll(`.${target.dataset.class}`).forEach(opt=>opt.classList.remove('selected')); target.classList.add('selected'); document.querySelector(target.dataset.input).value = target.dataset.value; },
            'close-modal': () => closeModal(id),
            'open-pipe-type-modal': () => openPipeTypeModal(id),
            'save-pipe-type': savePipeType,
            'open-inventory-history': () => openInventoryHistoryModal(id, target.dataset.name, target.dataset.isFuel === 'true'),
            'open-inventory-op-modal': openInventoryOperationModal,
            'select-op-type': () => selectOperationType(target.dataset.type),
            'save-inventory-op': saveInventoryOperation
        };
        if (actions[action]) actions[action]();
    });

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('password').addEventListener('keypress', e => { if (e.key === 'Enter') login(); });
        setupAuthListener();
    });
    </script>
</body>
</html>
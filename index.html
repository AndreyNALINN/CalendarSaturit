<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Управление бригадами и складом</title>
    <!-- ... все теги <meta> и <link> остаются без изменений ... -->
    <style>
        /* ... все стили остаются без изменений ... */
    </style>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      import { getFirestore, collection, onSnapshot, doc, getDoc, addDoc, updateDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
      import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    
      const firebaseConfig = {
        apiKey: "AIzaSyCsWfzOoerj6TiM2am46reV42CQ0OE7TM8",
        authDomain: "calendarsaturit.firebaseapp.com",
        projectId: "calendarsaturit",
        storageBucket: "calendarsaturit.appspot.com",
        messagingSenderId: "286002422636",
        appId: "1:286002422636:web:58b626bffddfb64b060949",
        measurementId: "G-8GC7ZJ94TW"
      };
    
      const app = initializeApp(firebaseConfig);
      window.db = getFirestore(app);
      window.auth = getAuth(app);
      window.firebase = {
          db: { collection, onSnapshot, doc, getDoc, addDoc, updateDoc, deleteDoc, setDoc },
          auth: { onAuthStateChanged, signInWithEmailAndPassword, signOut }
      };
      document.addEventListener('DOMContentLoaded', () => setupAuthListener());
    </script>
</head>
<body>
    <!-- ... вся HTML структура (login-screen, main-app, etc) остается без изменений ... -->
    <script>
    // ==================================================================
    // ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ (без изменений)
    // ==================================================================
    let events = [], teams = [], employees = [], pipeTypes = [], inventoryOperations = [], requests = [];
    let currentUser = null, currentDate = new Date(), unsubscribeListeners = [], editedEntity = null;

    // ==================================================================
    // АУТЕНТИФИКАЦИЯ И ИНИЦИАЛИЗАЦИЯ (без изменений)
    // ==================================================================
    function setupAuthListener() { /* ... код без изменений ... */ }
    async function login() { /* ... код без изменений ... */ }
    function logout() { /* ... код без изменений ... */ }
    async function initializeApp() { /* ... код без изменений ... */ }
    function listenToData() { /* ... код без изменений ... */ }
    
    // ==================================================================
    // РЕНДЕР ИНТЕРФЕЙСА (без изменений)
    // ==================================================================
    function renderCalendar() { /* ... код без изменений ... */ }
    function renderTeams() { /* ... код без изменений ... */ }
    function renderEmployees() {
        const list = document.getElementById('employees-list');
        if (!list) return;
        // Теперь мы показываем сотрудников из коллекции 'employees'
        list.innerHTML = employees.map(emp => `
            <div class="card">
                <p style="margin:0; font-weight:600;">${emp.name}</p>
                <p style="margin:4px 0 0; font-size:12px; color:#6c757d;">${emp.role === 'manager' ? 'Управляющий' : 'Сотрудник'}</p>
                 <div style="margin-top:10px; text-align:right;">
                    <button class="button-danger" style="padding:8px 12px; min-height:0;" onclick="deleteEntity('employees', '${emp.id}')">Удалить</button>
                </div>
            </div>
        `).join('') || '<p>Сотрудников пока нет.</p>';
    }

    // ==================================================================
    // СКЛАД (без изменений)
    // ==================================================================
    function renderInventoryGrid() { /* ... код без изменений ... */ }
    // ... все остальные функции склада

    // ==================================================================
    // УПРАВЛЕНИЕ БРИГАДАМИ И СОТРУДНИКАМИ (ИЗМЕНЕНО!)
    // ==================================================================
    function openTeamModal(teamId = null) { /* ... код без изменений ... */ }
    async function saveTeam() { /* ... код без изменений ... */ }

    // НОВАЯ ЛОГИКА ДЛЯ СОЗДАНИЯ СОТРУДНИКА
    function openEmployeeModal() {
        createModal('employee-modal', {
            title: 'Добавить сотрудника',
            body: `
                <p style="font-size:13px; color:#6c757d; margin-top:0;"><b>Шаг 1:</b> Создайте пользователя (логин/пароль) в консоли Firebase в разделе Authentication.</p>
                <p style="font-size:13px; color:#6c757d;"><b>Шаг 2:</b> Скопируйте его User UID и вставьте сюда.</p>
                <div class="form-group"><label>ФИО сотрудника</label><input id="employee-name" placeholder="Иванов Иван"></div>
                <div class="form-group"><label>User UID из Firebase</label><input id="employee-uid" placeholder="Скопируйте UID сюда"></div>
                <div class="form-group"><label>Роль</label><div class="role-selector" id="modal-role"></div></div>
            `,
            footer: `<button class="button-secondary" onclick="closeModal('employee-modal')">Отмена</button><button onclick="createEmployeeRecord()">Сохранить</button>`
        });
        const roles = { manager: 'Управляющий', employee: 'Сотрудник' };
        document.getElementById('modal-role').innerHTML = Object.keys(roles).map(key => 
            `<button class="role-option" onclick="selectModalOption(this, 'role-option', '#modal-role-value', '${key}')">${roles[key]}</button>`
        ).join('') + `<input type="hidden" id="modal-role-value" value="employee">`;
    }

    async function createEmployeeRecord() {
        const name = document.getElementById('employee-name').value.trim();
        const uid = document.getElementById('employee-uid').value.trim();
        const role = document.getElementById('modal-role-value').value;

        if (!name || !uid || !role) {
            return showNotification("Заполните все поля", "error");
        }

        showNotification("Сохранение данных...", "info");
        try {
            // 1. Создаем запись в коллекции 'users' для логина
            const userDocRef = window.firebase.db.doc(window.db, "users", uid);
            await window.firebase.db.setDoc(userDocRef, { name, role });

            // 2. Создаем запись в коллекции 'employees' для отображения в списке
            const empCollectionRef = window.firebase.db.collection(window.db, "employees");
            await window.firebase.db.addDoc(empCollectionRef, { name, role, uid });

            showNotification("Сотрудник успешно добавлен!", "success");
            closeModal('employee-modal');
        } catch (error) {
            console.error("Ошибка добавления сотрудника:", error);
            showNotification(error.message, "error");
        }
    }
    
    /* ... остальные функции (saveEntity, deleteEntity) без изменений ... */

    // ==================================================================
    // ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ (и глобальные вызовы)
    // ==================================================================
    /* ... все хелперы и глобальные вызовы window.func = func без изменений ... */
    </script>
</body>
</html>
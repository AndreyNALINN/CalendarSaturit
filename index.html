<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    
    <!-- PWA Meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Бригады">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" sizes="152x152" href="icon-152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icon-16.png">
    <link rel="manifest" href="manifest.json">
    <link rel="mask-icon" href="safari-pinned-tab.svg" color="#667eea">
    
    <title>Управление бригадами и складом</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        :root {
            --tab-bar-height: 70px;
        }

        * {
            box-sizing: border-box;
        }
        
        html {
            width: 100%;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            position: relative;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            color: #1d1d1f;
            font-size: 14px;
            padding-bottom: calc(var(--tab-bar-height) + env(safe-area-inset-bottom));
        }
        
        *:not(script):not(style) {
            -webkit-user-select: none; user-select: none;
        }
        
        input, textarea, select {
            -webkit-user-select: text; user-select: text;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
            box-sizing: border-box;
            position: relative;
        }
        
        @media (min-width: 768px) {
            .container {
                max-width: 1200px; padding: 20px;
            }
            body {
                font-size: 16px;
            }
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            position: relative;
        }
        
        @media (min-width: 768px) {
            .header {
                border-radius: 20px; padding: 20px; margin-bottom: 20px;
            }
        }
        
        .header h1 {
            margin: 0;
            color: #1d1d1f;
            font-size: 16px;
            font-weight: 600;
            flex-grow: 1;
            min-width: 120px;
        }
        
        @media (min-width: 480px) {
            .header h1 { font-size: 20px; }
        }
        
        @media (min-width: 768px) {
            .header h1 { font-size: 28px; }
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .user-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }
        
        @media (min-width: 768px) {
            .user-badge {
                padding: 8px 16px; border-radius: 20px; font-size: 14px; max-width: none;
            }
        }

        #reports-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            min-height: 40px;
        }
        
        .logout-btn {
            background: #ff3b30;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
            min-height: 40px;
        }
        
        @media (min-width: 768px) {
            .logout-btn, #reports-btn {
                padding: 10px 18px; border-radius: 20px; font-size: 14px;
            }
        }
        
        .logout-btn:hover {
            background: #d70015; transform: translateY(-2px);
        }
        
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        @media (min-width: 768px) {
            .main-content { border-radius: 20px; }
        }
        
        .tabs {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--tab-bar-height);
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            background: rgba(248, 249, 250, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .tab {
            padding: 4px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 11px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 100%;
            border-top: 3px solid transparent;
        }
        .tab span:first-child {
            font-size: 20px;
        }
        
        @media (min-width: 768px) {
            .tab {
                flex: 1; font-size: 16px; flex-direction: row;
            }
        }
        
        .tab.active {
            color: #667eea; border-top-color: #667eea;
        }
        
        .tab:hover:not(.active) {
            background: rgba(233, 236, 239, 0.5); color: #495057;
        }
        
        .tab-content {
            display: none; padding: 15px; animation: fadeIn 0.3s ease;
        }
        
        @media (min-width: 768px) {
            .tab-content { padding: 30px; }
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            margin-bottom: 1px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e9ecef;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
            touch-action: pan-y;
        }
        
        .calendar-header {
            text-align: center;
            font-weight: 600;
            padding: 10px 4px;
            background: #667eea;
            color: white;
            font-size: 12px;
        }
        
        @media (min-width: 768px) {
            .calendar-header { padding: 15px 10px; font-size: 14px; }
        }
        
        .calendar-day {
            background: white;
            padding: 2px;
            aspect-ratio: 1 / 1.6;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            flex-direction: column;
        }
        
        .calendar-day:hover {
            transform: scale(1.02); z-index: 10;
        }
        
        .calendar-day.today {
            box-shadow: inset 0 0 0 2px #007aff; z-index: 50; position: relative;
        }
        
        .calendar-day.other-month {
            background: #f8f9fa; color: #adb5bd; cursor: default;
        }
        .calendar-day.other-month:hover {
            transform: none;
        }
        
        .day-number {
            font-weight: 600;
            font-size: 10px;
            line-height: 1;
            align-self: flex-start;
            padding: 2px;
            color: #333;
            position: relative;
            z-index: 5;
        }
        
        @media (min-width: 768px) {
            .day-number { font-size: 16px; }
        }
        
        .events-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 2px;
        }

        .work-events-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .vacation-events-wrapper {
            position: relative;
            z-index: 3;
            display: flex;
            flex-direction: column-reverse;
            gap: 2px;
            margin-top: auto;
            padding-top: 24px;
        }
        
        .event {
            font-size: 8px;
            color: white;
            padding: 2px 4px;
            border-radius: 4px;
            white-space: normal;
            overflow: hidden;
            font-weight: 500;
            line-height: 1.2;
            max-width: 100%;
        }

        .event.work-event {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2px;
            color: #2c2c2e;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 10px;
            line-height: 1.3;
        }
        
        .event.work-event small {
            font-size: 0.8em; opacity: 0.8; display: block; font-weight: 500;
        }

        .event.vacation {
            width: 100%;
            padding: 2px 3px;
            border-radius: 2px;
            text-align: center;
            white-space: nowrap;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            color: #fff;
        }
        
        @media (min-width: 768px) {
            .event { font-size: 11px; }
            .event.work-event { font-size: 12px; }
            .event.vacation { padding: 4px 6px; border-radius: 4px; }
        }
        
        .upcoming-events-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px 0;
            gap: 10px;
            flex-wrap: wrap;
        }

        .upcoming-events-header h3 {
            margin: 0; color: #1d1d1f; font-weight: 600; font-size: 16px;
        }

        .upcoming-events-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .upcoming-events.expanded .upcoming-events-list {
            max-height: 500px;
        }
        
        .upcoming-events-header .arrow {
            transition: transform 0.3s ease; margin-left: auto;
        }

        .upcoming-events.expanded .arrow {
            transform: rotate(180deg);
        }
        
        .toggle-container {
            display: flex; align-items: center; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            padding: 15px;
            border-radius: 12px;
            width: calc(100% - 20px);
            max-width: 380px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
            margin: 10px;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: scale(0.8) translateY(-50px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        .day-events-list {
            margin-top: 20px; display: flex; flex-direction: column; gap: 12px;
        }

        .day-event-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .day-event-item.vacation {
            border-left-color: #28a745;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block; margin-bottom: 6px; font-weight: 600; color: #495057; font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            box-sizing: border-box;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            min-height: 44px;
            white-space: nowrap;
        }
        
        button:hover {
            transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .button-secondary { background: #6c757d; }
        .button-danger { background: linear-gradient(135deg, #ff3b30, #dc3545); }
        
        .card {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }
        
        .inventory-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;
        }
        
        .inventory-item {
            background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05); cursor: pointer;
        }
        
        .login-container {
            display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px;
        }
        
        .login-form {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px 20px;
            width: 100%;
            max-width: 350px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }
        
        .notification {
            position: fixed;
            top: 15px;
            right: 15px;
            background: #28a745;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            animation: slideInRight 0.3s ease;
            font-size: 13px;
            max-width: calc(100% - 30px);
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .upcoming-events {
            background: white; border-radius: 12px; padding: 5px 15px; margin-bottom: 15px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }
        
        .month-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            background: white;
            padding: 12px 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .month-navigation h2 {
            margin: 0; color: #1d1d1f; font-weight: 600; font-size: 18px;
        }
        
        .nav-button {
            background: #667eea; color: white; border: none; width: 40px; height: 40px; border-radius: 50%;
            cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; min-height: 40px;
        }

        .chip-selector {
            display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;
        }
        
        .chip-option {
            background: #f8f9fa; border: 2px solid #e9ecef; color: #495057; padding: 8px 12px; border-radius: 15px;
            cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.3s ease;
        }
        
        .chip-option.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; border-color: #667eea;
        }
        
        .event-type-selector {
            display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap;
        }
        
        .event-type-option {
            flex: 1;
            background: #f8f9fa; border: 2px solid #e9ecef; color: #495057; padding: 12px 14px;
            border-radius: 12px; cursor: pointer; font-size: 13px; text-align: center; min-width: 100px;
        }
        
        .event-type-option.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; border-color: #667eea;
        }
        
        .modal .button-group-end {
            display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; flex-wrap: wrap;
        }

        body:not(.requests-active) .container .header {
            display: none;
        }
        
        body:not(.calendar-active) .container .upcoming-events {
            display: none;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-size: 18px;
            color: #667eea;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">
        Загрузка данных...
    </div>

    <div id="login-screen" class="login-container" style="display: none;">
        <div class="login-form">
            <h2>Вход в систему</h2>
            <div class="form-group">
                <label for="username">Email</label>
                <input type="email" id="username" placeholder="Введите ваш email">
            </div>
            <div class="form-group">
                <label for="password">Пароль</label>
                <input type="password" id="password" placeholder="Введите пароль">
            </div>
            <button onclick="login()" style="width: 100%;">Войти</button>
        </div>
    </div>

    <div id="main-app" style="display: none;">
        <div class="container">
            <div class="header">
                <h1>Управление бригадами</h1>
                <div class="user-info">
                    <button id="reports-btn" style="display: none;">📊 <span class="btn-text">Отчет</span></button>
                    <div class="user-badge" id="user-badge"></div>
                    <button class="logout-btn" onclick="logout()">Выход</button>
                </div>
            </div>
            
            <div class="upcoming-events" id="upcoming-events" onclick="toggleUpcomingEvents()">
                <div class="upcoming-events-header">
                    <h3>Ближайшие события</h3>
                    <div class="upcoming-events-icons" id="upcoming-events-icons"></div>
                    <span class="arrow">▼</span>
                </div>
                <div class="upcoming-events-list" id="upcoming-events-list"></div>
            </div>
            
            <div class="main-content">
                <div id="calendar" class="tab-content active">
                    <div class="month-navigation">
                        <button class="nav-button" onclick="prevMonth()">‹</button>
                        <h2 id="current-month">Май 2023</h2>
                        <button class="nav-button" onclick="nextMonth()">›</button>
                    </div>
                    
                    <div class="calendar">
                        <div class="calendar-header">Пн</div>
                        <div class="calendar-header">Вт</div>
                        <div class="calendar-header">Ср</div>
                        <div class="calendar-header">Чт</div>
                        <div class="calendar-header">Пт</div>
                        <div class="calendar-header">Сб</div>
                        <div class="calendar-header">Вс</div>
                    </div>
                    
                    <div class="calendar-grid" id="calendar-days"></div>
                </div>
                
                <!-- Остальные вкладки (teams, inventory, requests) остаются без изменений в HTML структуре -->
                <div id="teams" class="tab-content">
                    <h2>Управление бригадами</h2>
                    <button onclick="openTeamModal()" style="margin-bottom: 20px;">Добавить бригаду</button>
                    <div id="teams-list"></div>
                    
                    <h2 style="margin-top: 30px;">Сотрудники</h2>
                    <button onclick="openEmployeeModal()" style="margin-bottom: 20px;">Добавить сотрудника</button>
                    <div id="employees-list"></div>
                </div>
                
                <div id="inventory" class="tab-content">
                    <h2>Учет склада</h2>
                    <div class="inventory-grid" id="inventory-grid"></div>
                </div>
                
                <div id="requests" class="tab-content">
                    <h2>Заявки</h2>
                    <div id="requests-list"></div>
                </div>
            </div>
        </div>
        
        <div class="tabs" id="main-tabs">
            <button class="tab active" onclick="switchTab('calendar')"><span>📅</span><span>Календарь</span></button>
            <button class="tab" onclick="switchTab('teams')" id="teams-tab"><span>👥</span><span>Бригады</span></button>
            <button class="tab" onclick="switchTab('inventory')"><span>📦</span><span>Склад</span></button>
            <button class="tab" onclick="switchTab('requests')" id="requests-tab"><span>📋</span><span>Заявки</span></button>
        </div>
    </div>
    
    <!-- Все модальные окна остаются без изменений в HTML структуре -->
    <div id="event-modal" class="modal">
        <div class="modal-content">
            <h2 id="event-modal-title">Добавить событие</h2>
            <input type="hidden" id="event-id">
            
            <div class="form-group">
                <label>Тип события</label>
                <div class="event-type-selector">
                    <div class="event-type-option selected" onclick="selectEventType(this, 'drilling')">⛏️ Бурение</div>
                    <div class="event-type-option" onclick="selectEventType(this, 'installation')">🔧 Монтаж</div>
                    <div class="event-type-option" onclick="selectEventType(this, 'trip')">🚚 Поездка</div>
                    <div class="event-type-option" onclick="selectEventType(this, 'vacation')">🏖️ Отпуск</div>
                </div>
                <input type="hidden" id="event-type" value="drilling">
            </div>
            
            <div id="work-fields">
                <div class="form-group">
                    <label for="event-date">Дата</label>
                    <input type="date" id="event-date">
                </div>
                <div class="form-group">
                    <label for="event-address">Адрес объекта</label>
                    <input type="text" id="event-address" placeholder="Введите адрес объекта">
                </div>
                <div class="form-group">
                    <label>Бригада</label>
                    <div class="chip-selector" id="team-chips"></div>
                    <input type="hidden" id="event-team">
                </div>
            </div>
            
            <div id="vacation-fields" style="display: none;">
                <div class="form-group">
                    <label>Сотрудник</label>
                    <div class="chip-selector" id="employee-chips"></div>
                    <input type="hidden" id="event-employee">
                </div>
                <div class="form-group">
                    <label for="event-start-date">Начало отпуска</label>
                    <input type="date" id="event-start-date">
                </div>
                <div class="form-group">
                    <label for="event-end-date">Конец отпуска</label>
                    <input type="date" id="event-end-date">
                </div>
            </div>
            
            <div class="button-group-end">
                <button class="button-secondary" onclick="closeModal('event-modal')">Отмена</button>
                <button id="save-event-btn" onclick="saveEvent()">Сохранить</button>
            </div>
        </div>
    </div>

    <div id="day-details-modal" class="modal">
        <div class="modal-content">
            <h2 id="day-details-title">События на день</h2>
            <div id="day-events-list"></div>
            <div class="button-group-end">
                <button class="button-secondary" onclick="closeModal('day-details-modal')">Закрыть</button>
                <button id="add-event-from-day-btn" onclick="addEventFromDayView()">Добавить</button>
            </div>
        </div>
    </div>
    
    <!-- Другие модальные окна (team, employee, inventory, etc.) -->
    
    <script>
        // ==================================================================
        // ПОДКЛЮЧЕНИЕ К FIREBASE
        // ==================================================================
        
        // !!! ШАГ 3: ВСТАВЬТЕ ВАШУ КОНФИГУРАЦИЮ FIREBASE СЮДА !!!
        const firebaseConfig = {
            apiKey: "AIz...HOLDER",
            authDomain: "YOUR-PROJECT.firebaseapp.com",
            projectId: "YOUR-PROJECT",
            storageBucket: "YOUR-PROJECT.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:12345...890"
        };

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ==================================================================
        // ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
        // ==================================================================

        // Данные теперь будут загружаться с сервера, поэтому мы начинаем с пустых массивов
        let events = [];
        let teams = [];
        let employees = [];
        let pipeTypes = [];
        let inventoryOperations = [];
        let requests = [];

        // Текущий пользователь будет определяться через Firebase
        let currentUser = null;

        // Остальные переменные состояния
        let currentDate = new Date();
        let selectedDate = null;
        let unsubscribeListeners = []; // Массив для хранения функций отписки от слушателей

        // ==================================================================
        // АУТЕНТИФИКАЦИЯ
        // ==================================================================

        // Главный слушатель, который определяет, вошел ли пользователь
        auth.onAuthStateChanged(async (user) => {
            // Удаляем старые подписки на данные, чтобы избежать утечек памяти
            unsubscribeListeners.forEach(unsubscribe => unsubscribe());
            unsubscribeListeners = [];

            if (user) {
                // Пользователь вошел. Получаем его данные из нашей базы `users`.
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };
                        console.log("Текущий пользователь:", currentUser.name, "Роль:", currentUser.role);
                        
                        document.getElementById('loading-overlay').style.display = 'none';
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('main-app').style.display = 'block';
                        
                        initializeApp(); // Запускаем основное приложение
                    } else {
                        // Если пользователь есть в Auth, но нет в базе `users`
                        console.error("Нет данных для пользователя в Firestore! Выход.");
                        showNotification("Ошибка данных пользователя. Обратитесь к администратору.", "error");
                        logout();
                    }
                } catch (error) {
                    console.error("Ошибка получения данных пользователя:", error);
                    logout();
                }
            } else {
                // Пользователь не вошел. Показываем экран логина.
                currentUser = null;
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
            }
        });

        async function login() {
            const email = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showNotification("Введите email и пароль", "error");
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                // onAuthStateChanged сделает все остальное
            } catch (error) {
                console.error("Ошибка входа:", error.message);
                showNotification("Неверный email или пароль", "error");
            }
        }

        function logout() {
            auth.signOut().catch(error => console.error("Ошибка выхода:", error));
        }

        // ==================================================================
        // ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ
        // ==================================================================

        function initializeApp() {
            console.log("Инициализация приложения...");
            
            // Настройка интерфейса в зависимости от роли
            document.getElementById('user-badge').textContent = `${currentUser.name} (${currentUser.role === 'manager' ? 'Управляющий' : 'Сотрудник'})`;
            
            const reportsBtn = document.getElementById('reports-btn');
            const teamsTab = document.getElementById('teams-tab');
            const requestsTab = document.getElementById('requests-tab');

            if (currentUser.role === 'manager') {
                reportsBtn.style.display = 'flex';
                teamsTab.style.display = 'flex';
                requestsTab.style.display = 'flex';
            } else {
                reportsBtn.style.display = 'none';
                teamsTab.style.display = 'none';
                requestsTab.style.display = 'none';
            }
            
            // Начинаем слушать данные с сервера в реальном времени
            listenToData();
            
            // Переключаемся на вкладку календаря по умолчанию
            switchTab('calendar');
        }

        function listenToData() {
            // Функция-обертка для создания слушателя
            const createListener = (collectionName, targetArray, renderFunction) => {
                const unsubscribe = db.collection(collectionName).onSnapshot(snapshot => {
                    targetArray.length = 0; // Очищаем массив
                    snapshot.forEach(doc => {
                        targetArray.push({ id: doc.id, ...doc.data() });
                    });
                    console.log(`Получены данные для '${collectionName}':`, targetArray.length, "записей");
                    if (renderFunction) renderFunction(); // Перерисовываем интерфейс
                }, error => {
                    console.error(`Ошибка при получении данных '${collectionName}':`, error);
                    showNotification(`Ошибка загрузки данных: ${collectionName}`, 'error');
                });
                unsubscribeListeners.push(unsubscribe); // Сохраняем, чтобы потом отписаться
            };

            // Создаем слушателей для всех наших коллекций
            createListener('events', events, () => { renderCalendar(); renderUpcomingEvents(); });
            createListener('teams', teams, renderTeams);
            createListener('employees', employees, renderEmployees);
            createListener('pipeTypes', pipeTypes, renderInventoryGrid);
            createListener('inventoryOperations', inventoryOperations, renderInventoryGrid);
            createListener('requests', requests, renderRequests);
        }

        // ==================================================================
        // ОСНОВНЫЕ ФУНКЦИИ (КАЛЕНДАРЬ, РЕНДЕРИНГ и т.д.)
        // ==================================================================
        
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabId)?.classList.add('active');

            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`)?.classList.add('active');
            
            const body = document.body;
            body.classList.remove('calendar-active', 'requests-active');
            if (tabId === 'calendar') body.classList.add('calendar-active');
            else if (tabId === 'requests') body.classList.add('requests-active');
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let firstDay = new Date(year, month, 1).getDay();
            firstDay = firstDay === 0 ? 6 : firstDay - 1;

            document.getElementById('current-month').textContent = getMonthName(currentDate);

            const calendarDaysEl = document.getElementById('calendar-days');
            calendarDaysEl.innerHTML = '';
            
            // Пустые ячейки в начале
            for (let i = 0; i < firstDay; i++) {
                calendarDaysEl.innerHTML += `<div class="calendar-day other-month"></div>`;
            }

            const today = formatDate(new Date());

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const formattedDate = formatDate(date);
                
                const workEventsOnDay = events.filter(e => e.date === formattedDate && ['drilling', 'installation', 'trip'].includes(e.type));
                const vacationEventsOnDay = events.filter(e => e.type === 'vacation' && e.startDate <= formattedDate && e.endDate >= formattedDate);

                let dayClasses = 'calendar-day';
                if (formattedDate === today) dayClasses += ' today';
                
                const workEventsHtml = workEventsOnDay.map(event => {
                    const teamColor = getTeamColor(event.teamId);
                    const teamNameAbbr = getTeamName(event.teamId).replace('Бурильщики', 'Бур.').replace('Монтажники', 'Монт.').replace('Водитель', 'Вод.');
                    const eventIcon = { drilling: '⛏️', installation: '🔧', trip: '🚚' }[event.type];
                    return `<div class="event work-event" style="background-color: ${teamColor};" title="${getTeamName(event.teamId)} - ${event.address}">
                                <div>${eventIcon} ${teamNameAbbr}<small>${event.address}</small></div>
                            </div>`;
                }).join('');

                const vacationEventsHtml = vacationEventsOnDay.map(event => {
                    const employeeName = getEmployeeName(event.employeeId).split(' ')[0];
                    return `<div class="event vacation" style="background-color: #34c759;" title="${getEmployeeName(event.employeeId)}">🏖️ ${employeeName}</div>`;
                }).join('');

                calendarDaysEl.innerHTML += `
                    <div class="${dayClasses}" onclick="openDayDetailsModal('${formattedDate}')">
                        <div class="work-events-wrapper">${workEventsHtml}</div>
                        <div class="day-number">${day}</div>
                        <div class="events-container">
                            <div class="vacation-events-wrapper">${vacationEventsHtml}</div>
                        </div>
                    </div>
                `;
            }
             // Пустые ячейки в конце
            const totalCells = firstDay + daysInMonth;
            const remainingCells = (totalCells % 7 === 0) ? 0 : 7 - (totalCells % 7);
            for (let i = 0; i < remainingCells; i++) {
                calendarDaysEl.innerHTML += `<div class="calendar-day other-month"></div>`;
            }
        }

        function renderUpcomingEvents() { /* ... код без изменений ... */ }
        function toggleUpcomingEvents() { /* ... код без изменений ... */ }

        function prevMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        // ==================================================================
        // РАБОТА С СОБЫТИЯМИ (CRUD)
        // ==================================================================

        function openDayDetailsModal(date) {
            selectedDate = date;
            document.getElementById('day-details-title').textContent = `События на ${date.split('-').reverse().join('.')}`;
            
            const dayEvents = events.filter(e => (e.date === date) || (e.type === 'vacation' && e.startDate <= date && e.endDate >= date));
            const listEl = document.getElementById('day-events-list');

            if (dayEvents.length === 0) {
                listEl.innerHTML = '<div style="color: #6c757d; text-align: center; padding: 20px 0;">Нет событий.</div>';
            } else {
                 listEl.innerHTML = dayEvents.map(event => {
                    const actionsHtml = currentUser.role === 'manager' 
                        ? `<button class="button-secondary" onclick="editEvent('${event.id}')">Изм.</button><button class="button-danger" onclick="deleteEvent('${event.id}')">Удл.</button>`
                        : '';
                    
                    if (event.type === 'vacation') {
                        return `<div class="day-event-item vacation"><div><strong>🏖️ Отпуск</strong><p>${getEmployeeName(event.employeeId)}</p></div><div>${actionsHtml}</div></div>`;
                    } else {
                        const teamColor = getTeamColor(event.teamId);
                        const eventTitle = { drilling: '⛏️ Бурение', installation: '🔧 Монтаж', trip: '🚚 Поездка' }[event.type];
                        return `<div class="day-event-item" style="border-left-color: ${teamColor}"><div><strong>${eventTitle}</strong><p>${getTeamName(event.teamId)} - ${event.address}</p></div><div>${actionsHtml}</div></div>`;
                    }
                }).join('');
            }
            
            document.getElementById('add-event-from-day-btn').style.display = currentUser.role === 'manager' ? 'inline-block' : 'none';
            openModal('day-details-modal');
        }

        async function saveEvent() {
            const eventId = document.getElementById('event-id').value;
            const isEditing = !!eventId;
            const type = document.getElementById('event-type').value;
            let newEventData;

            if (['drilling', 'installation', 'trip'].includes(type)) {
                newEventData = {
                    type: type,
                    date: document.getElementById('event-date').value,
                    address: document.getElementById('event-address').value.trim(),
                    teamId: document.getElementById('event-team').value,
                };
                if (!newEventData.date || !newEventData.address || !newEventData.teamId) {
                    return showNotification('Заполните все поля для рабочего события', 'error');
                }
            } else if (type === 'vacation') {
                newEventData = {
                    type: 'vacation',
                    startDate: document.getElementById('event-start-date').value,
                    endDate: document.getElementById('event-end-date').value,
                    employeeId: document.getElementById('event-employee').value,
                };
                if (!newEventData.startDate || !newEventData.endDate || !newEventData.employeeId) {
                    return showNotification('Заполните все поля для отпуска', 'error');
                }
            }

            try {
                if (isEditing) {
                    await db.collection('events').doc(eventId).update(newEventData);
                    showNotification('Событие обновлено');
                } else {
                    await db.collection('events').add(newEventData);
                    showNotification('Событие добавлено');
                }
                closeModal('event-modal');
            } catch (error) {
                console.error("Ошибка сохранения события:", error);
                showNotification('Ошибка сохранения события', 'error');
            }
        }
        
        async function deleteEvent(eventId) {
            if (!confirm('Вы уверены, что хотите удалить это событие?')) return;
            try {
                await db.collection('events').doc(eventId).delete();
                showNotification('Событие удалено');
                closeModal('day-details-modal');
            } catch (error) {
                console.error("Ошибка удаления события:", error);
                showNotification('Ошибка удаления', 'error');
            }
        }

        // ==================================================================
        // ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ (хелперы)
        // ==================================================================

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            if (type === 'error') {
                notification.style.background = '#ff3b30';
            }
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function formatDate(date) {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1), day = '' + d.getDate(), year = d.getFullYear();
            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;
            return [year, month, day].join('-');
        }
        
        function getMonthName(date) {
            return date.toLocaleString('ru-RU', { month: 'long', year: 'numeric' });
        }

        function getTeamName(id) {
            const team = teams.find(t => t.id === id);
            return team ? team.name : "Неизвестная бригада";
        }
        
        function getTeamColor(id) {
            const team = teams.find(t => t.id === id);
            return team ? team.color : "#cccccc";
        }
        
        function getEmployeeName(id) {
            const employee = employees.find(e => e.id === id);
            return employee ? employee.name : "Неизвестный сотрудник";
        }
        
        function openModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        
        function editEvent(eventId) { /* ... код для заполнения формы ... */ }
        function addEventFromDayView() { /* ... код для открытия модального окна ... */ }
        function selectEventType(element, type) { /* ... код для переключения типа события ... */ }
        function renderTeams() { /* ... код для отрисовки бригад ... */ }
        function renderEmployees() { /* ... код для отрисовки сотрудников ... */ }
        function renderInventoryGrid() { /* ... код для отрисовки склада ... */ }
        function renderRequests() { /* ... код для отрисовки заявок ... */ }

        // Добавляем обработчик нажатия Enter для поля пароля
        document.getElementById('password').addEventListener('keypress', e => { if (e.key === 'Enter') login(); });
        
        // Тут должен быть остальной JS код вашего приложения (openTeamModal, saveTeam и т.д.),
        // который также нужно будет переписать для работы с Firestore.
        // Я оставил основные функции, чтобы показать принцип.
    </script>
</body>
</html>
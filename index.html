<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–∏–≥–∞–¥–∞–º–∏ –∏ —Å–∫–ª–∞–¥–æ–º</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --tab-bar-height: 70px; }
        * { box-sizing: border-box; }
        html { width: 100%; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        body { margin: 0; padding: 0; width: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; color: #1d1d1f; font-size: 14px; padding-bottom: calc(var(--tab-bar-height) + env(safe-area-inset-bottom)); }
        *:not(script):not(style) { -webkit-user-select: none; user-select: none; }
        input, textarea, select { -webkit-user-select: text; user-select: text; }
        .container { max-width: 100%; margin: 0 auto; padding: 10px; }
        .header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); display: none; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .header h1 { margin: 0; font-size: 18px; font-weight: 600; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-badge { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 6px 12px; border-radius: 15px; font-size: 12px; }
        .logout-btn { background: #ff3b30; color: white; border: none; padding: 8px 14px; border-radius: 15px; cursor: pointer; font-size: 13px; min-height: 40px; }
        .main-content { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 15px; }
        .tabs { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--tab-bar-height); display: grid; grid-template-columns: repeat(4, 1fr); background: rgba(248, 249, 250, 0.7); backdrop-filter: blur(15px); border-top: 1px solid rgba(0, 0, 0, 0.1); z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .tab { padding: 4px; text-align: center; cursor: pointer; border: none; background: transparent; font-size: 11px; color: #6c757d; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; height: 100%; border-top: 3px solid transparent; }
        .tab span:first-child { font-size: 20px; }
        .tab.active { color: #667eea; border-top-color: #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e9ecef; border-radius: 8px; overflow: hidden; }
        .calendar-header { text-align: center; font-weight: 600; padding: 10px 4px; background: #667eea; color: white; font-size: 12px; }
        .calendar-day { background: white; padding: 2px; aspect-ratio: 1 / 1.5; overflow-y: auto; position: relative; cursor: pointer; display: flex; flex-direction: column; gap: 2px; }
        .calendar-day.today .day-number { background-color: #007aff; color: white; border-radius: 50%; width: 20px; height: 20px; display:inline-flex; align-items:center; justify-content:center; }
        .calendar-day.other-month { background: #f8f9fa; cursor: default; }
        .day-number { font-weight: 600; font-size: 10px; padding: 2px; line-height: 1; }
        .event { font-size: 9px; color: white; padding: 2px 4px; border-radius: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        .modal-content { background: white; padding: 20px; border-radius: 12px; width: 100%; max-width: 420px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; }
        input, select, textarea { width: 100%; padding: 12px 14px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 14px; }
        button { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 18px; border-radius: 12px; cursor: pointer; font-size: 14px; font-weight: 500; min-height: 44px; }
        .button-secondary { background: #6c757d; }
        .button-danger { background: #ff3b30; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05); }
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-form { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 30px 20px; width: 100%; max-width: 350px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2); }
        .notification { position: fixed; top: 15px; right: 15px; background: #28a745; color: white; padding: 12px 16px; border-radius: 8px; z-index: 1001; }
        .month-navigation { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 12px 15px; background: white; border-radius: 10px; }
        .nav-button { background: #667eea; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; min-height: 40px; }
        .chip-selector, .team-type-selector, .role-selector, .event-type-selector { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
        .chip-option, .team-type-option, .role-option, .event-type-option { flex: 1; background: #f8f9fa; border: 2px solid #e9ecef; color: #495057; padding: 10px; border-radius: 12px; cursor: pointer; text-align: center; font-size: 12px; }
        .chip-option.selected, .team-type-option.selected, .role-option.selected, .event-type-option.selected { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-color: #667eea; }
        .modal .button-group-end { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: flex; justify-content: center; align-items: center; z-index: 9999; font-size: 18px; color: #667eea; font-weight: 500; transition: opacity 0.3s ease; }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <div id="login-screen" class="login-container" style="display: none;">
        <div class="login-form">
            <h2>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
            <div class="form-group"><label for="username">Email</label><input type="email" id="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email"></div>
            <div class="form-group"><label for="password">–ü–∞—Ä–æ–ª—å</label><input type="password" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"></div>
            <button data-action="login" style="width: 100%;">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <div id="main-app" style="display: none;">
        <div class="container">
            <div class="header">
                <h1 id="header-title"></h1>
                <div class="user-info">
                    <div class="user-badge" id="user-badge"></div>
                    <button class="logout-btn" data-action="logout">–í—ã—Ö–æ–¥</button>
                </div>
            </div>
            <div class="main-content">
                <div id="calendar" class="tab-content"><div class="month-navigation"><button class="nav-button" data-action="prev-month">‚Äπ</button><h2 id="current-month"></h2><button class="nav-button" data-action="next-month">‚Ä∫</button></div><div class="calendar-grid" id="calendar-days"></div></div>
                <div id="teams" class="tab-content"><h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–∏–≥–∞–¥–∞–º–∏</h2><button data-action="open-team-modal">–î–æ–±–∞–≤–∏—Ç—å –±—Ä–∏–≥–∞–¥—É</button><div id="teams-list" style="margin-top: 20px;"></div><h2 style="margin-top:30px;">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h2><button data-action="open-employee-modal">–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button><div id="employees-list" style="margin-top: 20px;"></div></div>
                <div id="inventory" class="tab-content"><h2>–£—á–µ—Ç —Å–∫–ª–∞–¥–∞</h2><div id="inventory-grid"></div></div>
            </div>
        </div>
        <div class="tabs" id="main-tabs">
            <button class="tab" data-action="switch-tab" data-tab-id="calendar"><span>üìÖ</span><span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></button>
            <button class="tab" data-action="switch-tab" data-tab-id="teams" id="teams-tab"><span>üë•</span><span>–ë—Ä–∏–≥–∞–¥—ã</span></button>
            <button class="tab" data-action="switch-tab" data-tab-id="inventory"><span>üì¶</span><span>–°–∫–ª–∞–¥</span></button>
            <button class="tab" data-action="switch-tab" data-tab-id="requests" id="requests-tab"><span>üìã</span><span>–ó–∞—è–≤–∫–∏</span></button>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyCsWfzOoerj6TiM2am46reV42CQ0OE7TM8",
        authDomain: "calendarsaturit.firebaseapp.com",
        projectId: "calendarsaturit",
        storageBucket: "calendarsaturit.appspot.com",
        messagingSenderId: "286002422636",
        appId: "1:286002422636:web:58b626bffddfb64b060949",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let events = [], teams = [], employees = [], pipeTypes = [], inventoryOperations = [];
    let currentUser = null, currentDate = new Date(), unsubscribeListeners = [], editedEntity = null, selectedDate = null;

    // AUTH & INIT
    auth.onAuthStateChanged(async (user) => {
        unsubscribeListeners.forEach(unsub => unsub());
        unsubscribeListeners = [];
        if (user) {
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (!userDoc.exists) throw new Error("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firestore!");
                currentUser = { uid: user.uid, ...userDoc.data() };
                initializeApp();
            } catch (error) { logout(error); }
        } else {
            currentUser = null;
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            hideLoading();
        }
    });

    function initializeApp() {
        document.getElementById('main-app').style.display = 'block';
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('user-badge').textContent = `${currentUser.name} (${currentUser.role === 'manager' ? '–£–ø—Ä.' : '–°–æ—Ç—Ä.'})`;
        document.getElementById('teams-tab').style.display = currentUser.role === 'manager' ? 'flex' : 'none';
        document.getElementById('requests-tab').style.display = 'none';
        listenToData();
        switchTab('calendar');
        hideLoading();
    }
    
    function listenToData() {
        const collections = ['events', 'teams', 'employees', 'pipeTypes', 'inventoryOperations'];
        const renderAll = () => { renderCalendar(); renderTeams(); renderEmployees(); renderInventoryGrid(); };
        collections.forEach(name => {
            const unsub = db.collection(name).onSnapshot(snapshot => {
                window[name] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            }, error => console.error(`–û—à–∏–±–∫–∞ '${name}':`, error));
            unsubscribeListeners.push(unsub);
        });
    }

    // RENDERING
    function renderCalendar() {
        const year = currentDate.getFullYear(), month = currentDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        let firstDay = new Date(year, month, 1).getDay();
        firstDay = firstDay === 0 ? 6 : firstDay - 1;
        document.getElementById('current-month').textContent = getMonthName(currentDate);
        const grid = document.getElementById('calendar-days');
        const headers = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
        grid.innerHTML = headers.map(h => `<div class="calendar-header">${h}</div>`).join('');
        for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="calendar-day other-month"></div>`;
        const today = formatDate(new Date());
        for (let day = 1; day <= daysInMonth; day++) {
            const formattedDate = formatDate(new Date(year, month, day));
            const dayEvents = events.filter(e => (e.date === formattedDate) || (e.type === 'vacation' && e.startDate <= formattedDate && e.endDate >= formattedDate));
            let dayClasses = 'calendar-day' + (formattedDate === today ? ' today' : '');
            let eventsHtml = dayEvents.map(event => {
                const color = event.type === 'vacation' ? '#34c759' : getTeamColor(event.teamId);
                const text = event.type === 'vacation' ? `üèñÔ∏è ${getEmployeeName(event.employeeId)}` : `üîß ${getTeamName(event.teamId)}`;
                return `<div class="event" style="background-color:${color};" title="${text}">${text}</div>`;
            }).join('');
            grid.innerHTML += `<div class="${dayClasses}" data-action="open-day-details" data-date="${formattedDate}"><div class="day-number">${day}</div>${eventsHtml}</div>`;
        }
    }
    function renderTeams() { /* ... –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */ }
    function renderEmployees() { /* ... –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */ }
    function renderInventoryGrid() { /* ... –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */ }

    // MODALS & CRUD
    function openDayDetailsModal(date) {
        selectedDate = date;
        const dayEvents = events.filter(e => (e.date === date) || (e.type === 'vacation' && e.startDate <= date && e.endDate >= date));
        let body = dayEvents.map(event => {
            const title = event.type === 'vacation' ? `üèñÔ∏è –û—Ç–ø—É—Å–∫: ${getEmployeeName(event.employeeId)}` : `üîß ${getTeamName(event.teamId)}: ${event.address}`;
            return `<div class="card">${title}<div style="float:right; display:flex; gap:5px;"><button class="button-secondary" data-action="open-event-modal" data-id="${event.id}">–ò–∑–º.</button><button class="button-danger" data-action="delete-entity" data-collection="events" data-id="${event.id}">–£–¥–ª.</button></div></div>`
        }).join('') || '<p>–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å —Å–æ–±—ã—Ç–∏–π –Ω–µ—Ç.</p>';
        createModal('day-details', { title: `–°–æ–±—ã—Ç–∏—è –Ω–∞ ${date.split('-').reverse().join('.')}`, body, footer: `<button class="button-secondary" data-action="close-modal" data-modal-id="day-details">–ó–∞–∫—Ä—ã—Ç—å</button><button data-action="open-event-modal">–î–æ–±–∞–≤–∏—Ç—å</button>` });
    }

    function openEventModal(eventId = null) {
        editedEntity = eventId ? events.find(e => e.id === eventId) : {};
        if (!eventId) selectedDate = selectedDate || formatDate(new Date());
        
        createModal('event-modal', {
            title: editedEntity.id ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ' : '–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ',
            body: `<div class="form-group"><label>–¢–∏–ø</label><div class="event-type-selector" id="modal-event-type"></div></div>
                   <div id="work-fields" style="display:none;"><div class="form-group"><label>–ê–¥—Ä–µ—Å</label><input id="event-address" value="${editedEntity.address || ''}"></div><div class="form-group"><label>–ë—Ä–∏–≥–∞–¥–∞</label><div id="team-chips"></div></div></div>
                   <div id="vacation-fields" style="display:none;"><div class="form-group"><label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label><div id="employee-chips"></div></div><div class="form-group"><label>–ù–∞—á–∞–ª–æ</label><input type="date" id="event-start-date" value="${editedEntity.startDate || selectedDate}"></div><div class="form-group"><label>–ö–æ–Ω–µ—Ü</label><input type="date" id="event-end-date" value="${editedEntity.endDate || selectedDate}"></div></div>`,
            footer: `<button class="button-secondary" data-action="close-modal" data-modal-id="event-modal">–û—Ç–º–µ–Ω–∞</button><button data-action="save-event">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`
        });
        
        const eventTypes = { drilling: '–ë—É—Ä–µ–Ω–∏–µ', installation: '–ú–æ–Ω—Ç–∞–∂', trip: '–ü–æ–µ–∑–¥–∫–∞', vacation: '–û—Ç–ø—É—Å–∫' };
        document.getElementById('modal-event-type').innerHTML = Object.keys(eventTypes).map(key => `<button class="event-type-option" data-action="select-event-type" data-type="${key}">${eventTypes[key]}</button>`).join('');
        selectEventType(editedEntity.type || 'drilling');
    }

    function selectEventType(type) {
        document.querySelectorAll('.event-type-option').forEach(el => el.classList.toggle('selected', el.dataset.type === type));
        const isWork = ['drilling', 'installation', 'trip'].includes(type);
        document.getElementById('work-fields').style.display = isWork ? 'block' : 'none';
        document.getElementById('vacation-fields').style.display = type === 'vacation' ? 'block' : 'none';
        
        if(isWork) {
            const teamContainer = document.getElementById('team-chips');
            const relevantTeams = teams.filter(t => t.type && t.type.startsWith(type.slice(0,4)));
            teamContainer.innerHTML = relevantTeams.map(t => `<button class="chip-option ${editedEntity.teamId === t.id ? 'selected':''}" data-action="select-chip" data-input="#event-team" data-value="${t.id}">${t.name}</button>`).join('') + `<input type="hidden" id="event-team" value="${editedEntity.teamId || ''}">`;
        } else {
            const empContainer = document.getElementById('employee-chips');
            empContainer.innerHTML = employees.map(e => `<button class="chip-option ${editedEntity.employeeId === e.id ? 'selected':''}" data-action="select-chip" data-input="#event-employee" data-value="${e.id}">${e.name}</button>`).join('') + `<input type="hidden" id="event-employee" value="${editedEntity.employeeId || ''}">`;
        }
    }

    async function saveEvent() {
        const type = document.querySelector('.event-type-option.selected').dataset.type;
        let data;
        if (type === 'vacation') {
            data = { type, employeeId: document.querySelector('#event-employee').value, startDate: document.getElementById('event-start-date').value, endDate: document.getElementById('event-end-date').value };
            if (!data.employeeId || !data.startDate || !data.endDate) return showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
        } else {
            data = { type, teamId: document.querySelector('#event-team').value, address: document.getElementById('event-address').value.trim(), date: selectedDate };
            if (!data.teamId || !data.address) return showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–∏–≥–∞–¥—É –∏ –∞–¥—Ä–µ—Å', 'error');
        }
        await saveEntity('events', data);
        closeModal('event-modal');
    }

    // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π CRUD –∫–æ–¥ ...

    // HELPERS & EVENT HANDLING
    function createModal(id, content) {
        let m = document.getElementById(id);
        if (m) m.remove();
        m = document.createElement('div');
        m.id = id;
        m.className = 'modal';
        m.innerHTML = `<div class="modal-content"><h2>${content.title}</h2>${content.body}<div class="button-group-end">${content.footer}</div></div>`;
        document.body.appendChild(m);
        m.style.display = 'flex';
    }
    function closeModal(id) { const m = document.getElementById(id); if (m) m.remove(); }
    
    document.body.addEventListener('click', (e) => {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        const { action, id, collection, tabId, date, type, name, isFuel, value, input, class: cssClass, modalId } = target.dataset;

        // –ü—Ä–æ—Å—Ç–æ–µ –∏ –Ω–∞–¥–µ–∂–Ω–æ–µ –≤–µ—Ç–≤–ª–µ–Ω–∏–µ
        if (action === 'login') login();
        else if (action === 'logout') logout();
        else if (action === 'switch-tab') switchTab(tabId);
        else if (action === 'prev-month') { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); }
        else if (action === 'next-month') { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); }
        else if (action === 'open-day-details') openDayDetailsModal(date);
        else if (action === 'open-event-modal') openEventModal(id);
        else if (action === 'select-event-type') selectEventType(type);
        else if (action === 'save-event') saveEvent();
        else if (action === 'close-modal') closeModal(modalId);
        else if (action === 'delete-entity') deleteEntity(collection, id);
        // –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π...
    });
    
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('password').addEventListener('keypress', e => { if (e.key === 'Enter') login(); });
        setupAuthListener();
    });
    </script>
</body>
</html>
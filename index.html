<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–∏–≥–∞–¥–∞–º–∏ –∏ —Å–∫–ª–∞–¥–æ–º</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --tab-bar-height: 70px; }
        * { box-sizing: border-box; }
        html { width: 100%; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        body { margin: 0; padding: 0; width: 100%; height: 100%; overflow-x: hidden; position: relative; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; color: #1d1d1f; font-size: 14px; padding-bottom: calc(var(--tab-bar-height) + env(safe-area-inset-bottom)); }
        *:not(script):not(style) { -webkit-user-select: none; user-select: none; }
        input, textarea, select { -webkit-user-select: text; user-select: text; }
        .container { max-width: 100%; margin: 0 auto; padding: 10px; box-sizing: border-box; position: relative; }
        @media (min-width: 768px) { .container { max-width: 1200px; padding: 20px; } body { font-size: 16px; } }
        .header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); display: none; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; position: relative; }
        .header h1 { margin: 0; color: #1d1d1f; font-size: 16px; font-weight: 600; flex-grow: 1; min-width: 120px; }
        .user-info { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .user-badge { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: 500; }
        .logout-btn { background: #ff3b30; color: white; border: none; padding: 8px 14px; border-radius: 15px; cursor: pointer; font-size: 13px; min-height: 40px; }
        .main-content { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .tabs { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--tab-bar-height); display: grid; grid-template-columns: repeat(4, 1fr); background: rgba(248, 249, 250, 0.7); backdrop-filter: blur(15px); border-top: 1px solid rgba(0, 0, 0, 0.1); z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .tab { padding: 4px; text-align: center; cursor: pointer; border: none; background: transparent; font-size: 11px; font-weight: 500; color: #6c757d; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; height: 100%; border-top: 3px solid transparent; }
        .tab span:first-child { font-size: 20px; }
        .tab.active { color: #667eea; border-top-color: #667eea; }
        .tab-content { display: none; padding: 15px; }
        .tab-content.active { display: block; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e9ecef; border-radius: 8px; overflow: hidden; }
        .calendar-header { text-align: center; font-weight: 600; padding: 10px 4px; background: #667eea; color: white; font-size: 12px; }
        .calendar-day { background: white; padding: 2px; aspect-ratio: 1 / 1.6; overflow: hidden; position: relative; cursor: pointer; display: flex; flex-direction: column; }
        .calendar-day.today { box-shadow: inset 0 0 0 2px #007aff; z-index: 50; }
        .calendar-day.other-month { background: #f8f9fa; cursor: default; }
        .day-number { font-weight: 600; font-size: 10px; padding: 2px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        .modal-content { background: white; padding: 15px; border-radius: 12px; width: 100%; max-width: 420px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; }
        input, select, textarea { width: 100%; padding: 12px 14px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 14px; }
        button { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 18px; border-radius: 12px; cursor: pointer; font-size: 14px; font-weight: 500; min-height: 44px; }
        .button-secondary { background: #6c757d; }
        .button-danger { background: #ff3b30; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05); }
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-form { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 30px 20px; width: 100%; max-width: 350px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2); }
        .notification { position: fixed; top: 15px; right: 15px; background: #28a745; color: white; padding: 12px 16px; border-radius: 8px; z-index: 1001; }
        .month-navigation { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 12px 15px; background: white; border-radius: 10px; }
        .nav-button { background: #667eea; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; min-height: 40px; }
        .team-type-selector, .role-selector { display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
        .team-type-option, .role-option { flex: 1; background: #f8f9fa; border: 2px solid #e9ecef; color: #495057; padding: 12px 14px; border-radius: 12px; cursor: pointer; text-align: center; }
        .team-type-option.selected, .role-option.selected { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-color: #667eea; }
        .modal .button-group-end { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 9999; font-size: 18px; color: #667eea; font-weight: 500; transition: opacity 0.3s ease; }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <div id="login-screen" class="login-container" style="display: none;">
        <div class="login-form">
            <h2>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
            <div class="form-group"><label for="username">Email</label><input type="email" id="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email"></div>
            <div class="form-group"><label for="password">–ü–∞—Ä–æ–ª—å</label><input type="password" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"></div>
            <button data-action="login" style="width: 100%;">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <div id="main-app" style="display: none;">
        <div class="container">
            <div class="header">
                <h1 id="header-title"></h1>
                <div class="user-info">
                    <div class="user-badge" id="user-badge"></div>
                    <button class="logout-btn" data-action="logout">–í—ã—Ö–æ–¥</button>
                </div>
            </div>
            <div class="main-content">
                <div id="calendar" class="tab-content"><div class="month-navigation"><button class="nav-button" data-action="prev-month">‚Äπ</button><h2 id="current-month"></h2><button class="nav-button" data-action="next-month">‚Ä∫</button></div><div class="calendar-grid" id="calendar-days"></div></div>
                <div id="teams" class="tab-content"><h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–∏–≥–∞–¥–∞–º–∏</h2><button data-action="open-team-modal">–î–æ–±–∞–≤–∏—Ç—å –±—Ä–∏–≥–∞–¥—É</button><div id="teams-list" style="margin-top: 20px;"></div><h2 style="margin-top:30px;">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h2><button data-action="open-employee-modal">–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button><div id="employees-list" style="margin-top: 20px;"></div></div>
                <div id="inventory" class="tab-content"><h2>–£—á–µ—Ç —Å–∫–ª–∞–¥–∞</h2><div id="inventory-grid"></div></div>
            </div>
        </div>
        <div class="tabs" id="main-tabs">
            <button class="tab" data-action="switch-tab" data-tab-id="calendar"><span>üìÖ</span><span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></button>
            <button class="tab" data-action="switch-tab" data-tab-id="teams" id="teams-tab"><span>üë•</span><span>–ë—Ä–∏–≥–∞–¥—ã</span></button>
            <button class="tab" data-action="switch-tab" data-tab-id="inventory"><span>üì¶</span><span>–°–∫–ª–∞–¥</span></button>
            <button class="tab" data-action="switch-tab" data-tab-id="requests" id="requests-tab"><span>üìã</span><span>–ó–∞—è–≤–∫–∏</span></button>
        </div>
    </div>
    
    <!-- Firebase SDK - —Ä–µ–∂–∏–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <script>
    const firebaseConfig = {
        apiKey: "AIzaSyCsWfzOoerj6TiM2am46reV42CQ0OE7TM8",
        authDomain: "calendarsaturit.firebaseapp.com",
        projectId: "calendarsaturit",
        storageBucket: "calendarsaturit.appspot.com",
        messagingSenderId: "286002422636",
        appId: "1:286002422636:web:58b626bffddfb64b060949",
        measurementId: "G-8GC7ZJ94TW"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let events = [], teams = [], employees = [], pipeTypes = [], inventoryOperations = [];
    let currentUser = null, currentDate = new Date(), unsubscribeListeners = [], editedEntity = null, selectedInventoryItem = null;

    // ==========================================================
    // AUTH & INIT
    // ==========================================================
    auth.onAuthStateChanged(async (user) => {
        unsubscribeListeners.forEach(unsub => unsub());
        unsubscribeListeners = [];
        const loadingOverlay = document.getElementById('loading-overlay');
        if (user) {
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (!userDoc.exists) throw new Error("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firestore!");
                currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };
                await initializeApp();
            } catch (error) { logout(error); }
        } else {
            currentUser = null;
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            hideLoading();
        }
    });

    async function login() {
        const email = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        if (!email || !password) return showNotification("–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å", "error");
        try { await auth.signInWithEmailAndPassword(email, password); } 
        catch (error) { showNotification("–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å", "error"); }
    }

    function logout(error = null) {
        if(error) console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞, –≤—ã—Ö–æ–¥:", error);
        auth.signOut();
    }

    async function initializeApp() {
        document.getElementById('main-app').style.display = 'block';
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('user-badge').textContent = `${currentUser.name} (${currentUser.role === 'manager' ? '–£–ø—Ä–∞–≤–ª—è—é—â–∏–π' : '–°–æ—Ç—Ä—É–¥–Ω–∏–∫'})`;
        document.getElementById('teams-tab').style.display = currentUser.role === 'manager' ? 'flex' : 'none';
        document.getElementById('requests-tab').style.display = 'none';
        listenToData();
        switchTab('calendar');
        hideLoading();
    }

    function hideLoading() {
        const loadingOverlay = document.getElementById('loading-overlay');
        loadingOverlay.style.opacity = '0';
        setTimeout(() => loadingOverlay.style.display = 'none', 300);
    }

    function listenToData() {
        const collections = ['events', 'teams', 'employees', 'pipeTypes', 'inventoryOperations'];
        const renderAll = () => { renderCalendar(); renderTeams(); renderEmployees(); renderInventoryGrid(); };
        collections.forEach(name => {
            const unsub = db.collection(name).onSnapshot(snapshot => {
                window[name] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            });
            unsubscribeListeners.push(unsub);
        });
    }

    // ==========================================================
    // RENDERING
    // ==========================================================
    function renderCalendar() {
        const year = currentDate.getFullYear(), month = currentDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        let firstDay = new Date(year, month, 1).getDay();
        firstDay = firstDay === 0 ? 6 : firstDay - 1;
        document.getElementById('current-month').textContent = getMonthName(currentDate);
        const grid = document.getElementById('calendar-days');
        grid.innerHTML = '';
        const headers = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
        grid.innerHTML = headers.map(h => `<div class="calendar-header">${h}</div>`).join('');
        for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="calendar-day other-month"></div>`;
        const today = formatDate(new Date());
        for (let day = 1; day <= daysInMonth; day++) {
            const formattedDate = formatDate(new Date(year, month, day));
            const dayClasses = 'calendar-day' + (formattedDate === today ? ' today' : '');
            grid.innerHTML += `<div class="${dayClasses}" data-action="open-day-details" data-date="${formattedDate}"><div class="day-number">${day}</div></div>`;
        }
    }
    function renderTeams() { /* ... */ }
    function renderEmployees() { /* ... */ }
    function renderInventoryGrid() { /* ... */ }

    // ==========================================================
    // MODALS & CRUD
    // ==========================================================
    async function saveEntity(collectionName, data, successMessage = '–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã') {
        try {
            if (editedEntity && editedEntity.id) { await db.collection(collectionName).doc(editedEntity.id).update(data); } 
            else { await db.collection(collectionName).add(data); }
            showNotification(successMessage, 'success');
        } catch (error) { console.error("–û—à–∏–±–∫–∞:", error); showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error'); }
    }
    async function deleteEntity(collectionName, docId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) return;
        try { await db.collection(collectionName).doc(docId).delete(); showNotification('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞'); } 
        catch (error) { showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error'); }
    }
    // ... –∏ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω (openTeamModal, saveTeam, etc)
    
    // ==========================================================
    // HELPERS & EVENT HANDLING
    // ==========================================================
    function showNotification(message, type = 'success') { /* ... */ }
    function formatDate(d) { /* ... */ }
    function getMonthName(d) { /* ... */ }
    function switchTab(tabId) { /* ... */ }
    // ... –∏ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ö–µ–ª–ø–µ—Ä—ã
    
    document.body.addEventListener('click', (e) => {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        const action = target.dataset.action;
        const actions = {
            'login': login,
            'logout': logout,
            'switch-tab': () => switchTab(target.dataset.tabId),
            'prev-month': () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); },
            'next-month': () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); },
            // ... –∏ –¥—Ä—É–≥–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
        };
        if (actions[action]) actions[action]();
    });

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('password').addEventListener('keypress', e => { if (e.key === 'Enter') login(); });
        setupAuthListener();
    });
    </script>
</body>
</html>
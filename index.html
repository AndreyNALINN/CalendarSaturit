<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Управление бригадами и складом</title>
    <!-- ... все теги <meta> и <link> ... -->
    <style>
        /* ... все стили ... */
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">Загрузка...</div>

    <div id="login-screen" class="login-container" style="display: none;">
        <!-- ... HTML для формы входа ... -->
    </div>

    <div id="main-app" style="display: none;">
        <!-- ... вся HTML структура основного приложения ... -->
    </div>
    
    <!-- Firebase SDK - подключаем здесь -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js"></script>
    
    <!-- Весь наш код в одном месте -->
    <script>
    // ==================================================================
    // ИНИЦИАЛИЗАЦИЯ FIREBASE
    // ==================================================================
    const firebaseApp = firebase.app;
    const firebaseAuth = firebase.auth;
    const firestore = firebase.firestore;

    const firebaseConfig = {
        apiKey: "AIzaSyCsWfzOoerj6TiM2am46reV42CQ0OE7TM8",
        authDomain: "calendarsaturit.firebaseapp.com",
        projectId: "calendarsaturit",
        storageBucket: "calendarsaturit.appspot.com",
        messagingSenderId: "286002422636",
        appId: "1:286002422636:web:58b626bffddfb64b060949",
        measurementId: "G-8GC7ZJ94TW"
    };

    const app = firebaseApp.initializeApp(firebaseConfig);
    const auth = firebaseAuth.getAuth(app);
    const db = firestore.getFirestore(app);

    // ==================================================================
    // ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
    // ==================================================================
    let events = [], teams = [], employees = [], pipeTypes = [], inventoryOperations = [], requests = [];
    let currentUser = null, currentDate = new Date(), unsubscribeListeners = [], editedEntity = null, selectedInventoryItem = null;

    // ==================================================================
    // АУТЕНТИФИКАЦИЯ И ИНИЦИАЛИЗАЦИЯ
    // ==================================================================
    function setupAuthListener() {
        firebaseAuth.onAuthStateChanged(auth, async (user) => {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            const loadingOverlay = document.getElementById('loading-overlay');

            if (user) {
                try {
                    const userDoc = await firestore.getDoc(firestore.doc(db, 'users', user.uid));
                    if (!userDoc.exists()) throw new Error("Нет данных для пользователя в Firestore!");
                    currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };
                    await initializeApp();
                } catch (error) {
                    logout(error);
                }
            } else {
                currentUser = null;
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
                hideLoading();
            }
        });
    }

    async function login() {
        const email = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        if (!email || !password) return showNotification("Введите email и пароль", "error");
        try {
            await firebaseAuth.signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            showNotification("Неверный email или пароль", "error");
        }
    }

    function logout(error = null) {
        if(error) console.error("Критическая ошибка, выход:", error);
        firebaseAuth.signOut(auth);
    }
    
    // ... и так далее, ВЕСЬ остальной JS код, который мы писали, идет сюда ...
    // ... включая listenToData, все render-функции, CRUD-функции и обработчик событий ...

    // ==================================================================
    // ЗАПУСК ПРИЛОЖЕНИЯ
    // ==================================================================
    document.addEventListener('DOMContentLoaded', () => {
        // Привязываем обработчик событий к document.body
        document.body.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;

            const action = target.dataset.action;
            const id = target.dataset.id;
            // ... и так далее, вся логика обработчика ...
        });
        
        // Привязываем Enter к полю пароля
        document.getElementById('password').addEventListener('keypress', e => {
            if (e.key === 'Enter') login();
        });

        // Запускаем слушатель Firebase
        setupAuthListener();
    });

    </script>
</body>
</html>